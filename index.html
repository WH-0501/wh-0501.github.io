<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Daemo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Daemo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Damon">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Daemo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Daemo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">内诚于心，外信于人</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Damon</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">130</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/17/Robot/ROS/ros_control/%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/17/Robot/ROS/ros_control/%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-17 07:55:45" itemprop="dateCreated datePublished" datetime="2024-10-17T07:55:45+08:00">2024-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-19 09:36:54" itemprop="dateModified" datetime="2024-10-19T09:36:54+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/" itemprop="url" rel="index"><span itemprop="name">Robot</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/" itemprop="url" rel="index"><span itemprop="name">ROS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/ros-control/" itemprop="url" rel="index"><span itemprop="name">ros_control</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MoveIt"><a href="#MoveIt" class="headerlink" title="MoveIt"></a>MoveIt</h1><p>使用 moveit! 控制真实机械臂时，控制器中要有一个 action server 来接收 moveit! 的路径消息，然后控制器再将消息下发(write())到硬件执行；同时还要从机器人获取(read())机械臂各关节状态并上报给 moveit!。</p>
<p>示例1</p>
<p>ROS 驱动 6DOF 机械臂。创建两个节点：</p>
<ul>
<li><p>joint_controller</p>
</li>
<li><ul>
<li>实现 action server，接收 moveit! 路径消息</li>
<li>将路径消息转换为电机(关节)控制指令</li>
<li>获取位姿</li>
<li>发布位姿</li>
</ul>
</li>
<li><p>joint_serial</p>
</li>
<li><ul>
<li>接收 joint_controller 发布的控制指令，通过串口发送给机械臂</li>
</ul>
</li>
</ul>
<h1 id="Gazebo"><a href="#Gazebo" class="headerlink" title="Gazebo"></a>Gazebo</h1><img src="/2024/10/17/Robot/ROS/ros_control/%E4%BD%BF%E7%94%A8/image-20241017075618087.png" class="" title="image-20241017075618087">

<p>使用方法:</p>
<h2 id="URDF-中增加-transmission-元素"><a href="#URDF-中增加-transmission-元素" class="headerlink" title="URDF 中增加  transmission 元素"></a><strong>URDF 中增加  transmission 元素</strong></h2><p> 元素用于将 actuator 连接到 joints。</p>
<p>相对于当前的 gazebo_ros_control 实现， 标签中唯一重要的信息是：</p>
<ul>
<li><code>&lt;joint name=&quot;&quot;&gt;</code>: name 必须与 URDF 中某个 joint 的名字相对应</li>
<li><code>&lt;type&gt;</code>: transmission 的类型。当前只实现了 transmission_interface&#x2F;SimpleTransmission</li>
<li><code>&lt;hardwareInterface&gt;</code>: 在 <actuator> 和 <joint> 标签内，指明 gazebo_ros_control 插件要加载的硬件接口(如：position、velocity 或 effort 接口)。当前只实现了 effort 接口</li>
</ul>
<h2 id="添加-gazebo-ros-control-插件"><a href="#添加-gazebo-ros-control-插件" class="headerlink" title="添加 gazebo_ros_control 插件"></a><strong>添加 gazebo_ros_control 插件</strong></h2><p>除了 transmission 标签外，还需要在 URDF 中添加该插件项。该插件负责解析 transmission 标签并加载适当的硬件接口和控制器管理器。默认情况下，gazebo_ros_control 插件非常简单，尽管它还可以通过其他插件体系结构进行扩展，以允许高级用户在 ros_control 和 Gazebo 之间创建自己的自定义机器人硬件接口。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gazebo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">name</span>=<span class="string">&quot;gazebo_ros_control&quot;</span> <span class="attr">filename</span>=<span class="string">&quot;libgazebo_ros_control.so&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">robotNamespace</span>&gt;</span>/MYROBOT<span class="tag">&lt;/<span class="name">robotNamespace</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>gazebo_ros_control 包含以下可选元素：</p>
<ul>
<li><code>&lt;robotNamespace&gt;</code>: 命名空间</li>
<li><code>&lt;controlPeriod&gt;</code>: 控制周期</li>
<li><code>&lt;robotParam&gt;</code>: 参数服务器中 robot_description 的位置，默认为 ‘&#x2F;robot_description’</li>
<li><code>&lt;robotSimType&gt;</code>: 自定义的机器人 sim 接口的插件名称.默认为 DefaultRobotHWSim</li>
</ul>
<h2 id="默认行为"><a href="#默认行为" class="headerlink" title="默认行为"></a><strong>默认行为</strong></h2><p>默认情况下，如果没有  标签，gazebo_ros_control 会尝试从 URDF 中获取与基于 ros_control 的控制器接口所需的所有信息。</p>
<p>默认提供以下 ros_control 接口：</p>
<ul>
<li>hardware_interface::JointStateInterface</li>
<li>hardware_interface::EffortJointInterface</li>
<li>hardware_interface::VelocityJointInterface</li>
</ul>
<h2 id="自定义-gazebo-ros-control-仿真插件"><a href="#自定义-gazebo-ros-control-仿真插件" class="headerlink" title="自定义 gazebo_ros_control 仿真插件"></a><strong>自定义 gazebo_ros_control 仿真插件</strong></h2><p>gazebo_ros_control 插件还提供了一个基于 pluginlib 的接口，用于在 Gazebo 和 ros_control 之间实现自定义接口。</p>
<p>自定义插件必须继承 <strong>gazebo_ros_control::RobotHWSim</strong>，该插件实现了模拟的 ros_control <strong>hardware_interface::RobotHW</strong>。RobotHWSim 提供 API 级访问，以在 Gazebo 仿真器中读取和控制关节属性。</p>
<p>相应的 RobotHWSim 子类在 URDF 中指定，并在加载机器人模型时加载。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gazebo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">name</span>=<span class="string">&quot;gazebo_ros_control&quot;</span> <span class="attr">filename</span>=<span class="string">&quot;libgazebo_ros_control.so&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">robotNamespace</span>&gt;</span>/MYROBOT<span class="tag">&lt;/<span class="name">robotNamespace</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">robotSimType</span>&gt;</span>gazebo_ros_control/DefaultRobotHWSim<span class="tag">&lt;/<span class="name">robotSimType</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="PRBot-示例"><a href="#PRBot-示例" class="headerlink" title="PRBot 示例"></a><strong>PRBot 示例</strong></h2><p>为 Gazebo 将启动的每个关节添加一个  块。注意： 必须同时包含在  和  标签中。查看 rrbot.xacro(<a target="_blank" rel="noopener" href="https://github.com/ros-simulation/gazebo_ros_demos">gazebo_ros_demos</a>) 文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transmission</span> <span class="attr">name</span>=<span class="string">&quot;tran1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>transmission_interface/SimpleTransmission<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">&quot;joint1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hardwareInterface</span>&gt;</span>EffortJointInterface<span class="tag">&lt;/<span class="name">hardwareInterface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">actuator</span> <span class="attr">name</span>=<span class="string">&quot;motor1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hardwareInterface</span>&gt;</span>EffortJointInterface<span class="tag">&lt;/<span class="name">hardwareInterface</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mechanicalReduction</span>&gt;</span>1<span class="tag">&lt;/<span class="name">mechanicalReduction</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">actuator</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">transmission</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">transmission</span> <span class="attr">name</span>=<span class="string">&quot;tran2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>transmission_interface/SimpleTransmission<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">&quot;joint2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hardwareInterface</span>&gt;</span>EffortJointInterface<span class="tag">&lt;/<span class="name">hardwareInterface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">actuator</span> <span class="attr">name</span>=<span class="string">&quot;motor2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hardwareInterface</span>&gt;</span>EffortJointInterface<span class="tag">&lt;/<span class="name">hardwareInterface</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mechanicalReduction</span>&gt;</span>1<span class="tag">&lt;/<span class="name">mechanicalReduction</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">actuator</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">transmission</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>rrbot.gazebo 中会读取所有 <code>&lt;transmission&gt;</code>  标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gazebo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">name</span>=<span class="string">&quot;gazebo_ros_control&quot;</span> <span class="attr">filename</span>=<span class="string">&quot;libgazebo_ros_control.so&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">robotNamespace</span>&gt;</span>/rrbot<span class="tag">&lt;/<span class="name">robotNamespace</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="创建-ros-controls-包"><a href="#创建-ros-controls-包" class="headerlink" title="创建 ros_controls 包"></a><strong>创建 ros_controls 包</strong></h2><p>可参考 <a target="_blank" rel="noopener" href="https://github.com/ros-simulation/gazebo_ros_demos">gazebo_ros_demos</a> 中的 rrbot_control 包。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> ~/catkin_ws</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/catkin_ws</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">catkin_create_pkg MYROBOT_control controller_manager joint_state_controller robot_state_publisher</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> MYROBOT_control</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> config</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> launch</span></span><br></pre></td></tr></table></figure>



<h2 id="创建-yaml-配置文件"><a href="#创建-yaml-配置文件" class="headerlink" title="创建 yaml 配置文件"></a><strong>创建 yaml 配置文件</strong></h2><p>PID 增益和 controller 设置必须保存在 yaml 文件中，该文件通过 roslaunch 文件加载到参数服务器中。在 MYROBOT_control&#x2F;config 目录中，使用 RRBot 作为示例，创建 MRBot_control&#x2F;config&#x2F;rrbot_control.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rrbot:</span></span><br><span class="line">  <span class="comment"># Publish all joint states -----------------------------------</span></span><br><span class="line">  <span class="attr">joint_state_controller:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">joint_state_controller/JointStateController</span></span><br><span class="line">    <span class="attr">publish_rate:</span> <span class="number">50</span>  </span><br><span class="line"></span><br><span class="line">  <span class="comment"># Position Controllers ---------------------------------------</span></span><br><span class="line">  <span class="attr">joint1_position_controller:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">effort_controllers/JointPositionController</span></span><br><span class="line">    <span class="attr">joint:</span> <span class="string">joint1</span></span><br><span class="line">    <span class="attr">pid:</span> &#123;<span class="attr">p:</span> <span class="number">100.0</span>, <span class="attr">i:</span> <span class="number">0.01</span>, <span class="attr">d:</span> <span class="number">10.0</span>&#125;</span><br><span class="line">  <span class="attr">joint2_position_controller:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">effort_controllers/JointPositionController</span></span><br><span class="line">    <span class="attr">joint:</span> <span class="string">joint2</span></span><br><span class="line">    <span class="attr">pid:</span> &#123;<span class="attr">p:</span> <span class="number">100.0</span>, <span class="attr">i:</span> <span class="number">0.01</span>, <span class="attr">d:</span> <span class="number">10.0</span>&#125;</span><br></pre></td></tr></table></figure>



<h2 id="创建-launch-文件"><a href="#创建-launch-文件" class="headerlink" title="创建 launch 文件"></a><strong>创建 launch 文件</strong></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Load joint controller configurations from YAML file to parameter server --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rosparam</span> <span class="attr">file</span>=<span class="string">&quot;$(find rrbot_control)/config/rrbot_control.yaml&quot;</span> <span class="attr">command</span>=<span class="string">&quot;load&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- load the controllers --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;controller_spawner&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;controller_manager&quot;</span> <span class="attr">type</span>=<span class="string">&quot;spawner&quot;</span> <span class="attr">respawn</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span> <span class="attr">ns</span>=<span class="string">&quot;/rrbot&quot;</span> <span class="attr">args</span>=<span class="string">&quot;joint1_position_controller joint2_position_controller joint_state_controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- convert joint states to TF transforms for rviz, etc --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;robot_state_publisher&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;robot_state_publisher&quot;</span> <span class="attr">type</span>=<span class="string">&quot;robot_state_publisher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">respawn</span>=<span class="string">&quot;false&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/joint_states&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/rrbot/joint_states&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller_spawner 节点通过运行 python 脚本启动 RRBot 的两个关节位置控制器(joint1_position_controller、joint2_position_controller)，该脚本对 ros_control 控制器管理器进行服务调用。</p>
<p>service calls 告诉控制器管理器想要哪个控制器。它还加载了第三个控制器，该控制器使用 hardware_interfaces 发布所有关节的关节状态，并在 &#x2F;joint_states 主题上发布。</p>
<p>最后，启动 <strong>robot_state_publisher</strong> 节点，该节点监听来自 joint_state_controller 的 &#x2F;joint_states 主题消息，然后将其转换并发布到 &#x2F;tf。这样就可以在 Rviz 中查看。</p>
<h2 id="启动-controllers"><a href="#启动-controllers" class="headerlink" title="启动 controllers"></a><strong>启动 controllers</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">roslaunch rrbot_gazebo rrbot_world.launch</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">roslaunch rrbot_control rrbot_control.launch</span></span><br></pre></td></tr></table></figure>

<p>手动调用服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动加载 controllers. 默认均已加载,无需手动执行</span></span><br><span class="line">rosservice call /rrbot/controller_manager/load_controller &quot;name: &#x27;joint1_position_controller&#x27;&quot;</span><br><span class="line">rosservice call /rrbot/controller_manager/load_controller &quot;name: &#x27;joint2_position_controller&#x27;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 controllers. 默认均已启动,无需再执行</span></span><br><span class="line">rosservice call /rrbot/controller_manager/switch_controller &quot;&#123;start_controllers: [&#x27;joint1_position_controller&#x27;,&#x27;joint2_position_controller&#x27;], stop_controllers: [], strictness: 2&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 controllers</span></span><br><span class="line">rosservice call /rrbot/controller_manager/switch_controller &quot;&#123;start_controllers: [], stop_controllers: [&#x27;joint1_position_controller&#x27;,&#x27;joint2_position_controller&#x27;], strictness: 2&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>手动发送指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rostopic pub -1 /rrbot/joint1_position_controller/command std_msgs/Float64 &quot;data: 1.5&quot;</span><br><span class="line">rostopic pub -1 /rrbot/joint2_position_controller/command std_msgs/Float64 &quot;data: 1.0&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>也可使用 RQT 发送指令：</p>
<p><code>rosrun rqt_gui rqt_gui</code></p>
<p>打开工具窗口后，”plugins” -&gt; “Topics” -&gt; “Message Publisher”，然后选择 &#x2F;rrbot&#x2F;joints1_position_controller&#x2F;command 主题      </p>
<p>RQT 中使用正弦函数：        </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sin(i/100)</span><br><span class="line"></span><br><span class="line">sin(i/rate*speed)*diff + offset</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>i: RQT 时间变量</li>
<li>rate: 计算该表达式的频率。这个数字应该与主题发布者的 rate 列中的数字相同，建议设置为 100</li>
<li>speed: joint 执行速度</li>
<li>upper_limit 及 lower_limits: 被控制的硬件的关节限制</li>
<li>diff &#x3D; (upper_limit - lower_limit) &#x2F; 2</li>
<li>offset &#x3D; upper_limit - diff</li>
</ul>
</blockquote>
<p>PID 调节 <code>               rosrun rqt_reconfigure rqt_reconfigure             </code></p>
<h1 id="transmission-interface"><a href="#transmission-interface" class="headerlink" title="transmission_interface"></a>transmission_interface</h1><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p>该示例很简单，显示了如何通过 reducer(减速器) 将单个 actuator(执行器) 的位置传播(propagate)到关节空间</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;transmission_interface/simple_transmission.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;transmission_interface/transmission_interface.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">namespace</span> transmission_interface;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Raw data</span></span><br><span class="line">  <span class="type">double</span> a_pos;</span><br><span class="line">  <span class="type">double</span> j_pos;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Transmission</span></span><br><span class="line">  <span class="function">SimpleTransmission <span class="title">trans</span><span class="params">(<span class="number">10.0</span>)</span></span>; <span class="comment">// 10x reducer</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap raw data</span></span><br><span class="line">  ActuatorData a_data;</span><br><span class="line">  a_data.position.<span class="built_in">push_back</span>(&amp;a_pos);</span><br><span class="line"></span><br><span class="line">  JointData j_data;</span><br><span class="line">  j_data.position.<span class="built_in">push_back</span>(&amp;j_pos);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Transmission interface</span></span><br><span class="line">  ActuatorToJointPositionInterface act_to_jnt_pos;</span><br><span class="line">  act_to_jnt_pos.<span class="built_in">registerHandle</span>(<span class="built_in">ActuatorToJointPositionHandle</span>(<span class="string">&quot;trans&quot;</span>, &amp;trans, a_data, j_data));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Propagate actuator position to joint space</span></span><br><span class="line">  act_to_jnt_pos.<span class="built_in">propagate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><p>该示例描述一个有三个 actuators 和三个关节的机器人(如阿克曼小车)：</p>
<ul>
<li>第一个 actuator&#x2F;joint 通过减速机联接</li>
<li>后两个 actuators&#x2F;joints 通过差速器联接</li>
</ul>
<p>该硬件可以读取当前执行器的位置、速度和 effort，并发送位置命令。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;transmission_interface/simple_transmission.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;transmission_interface/differential_transmission.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;transmission_interface/transmission_interface.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::vector;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> transmission_interface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyRobot</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MyRobot</span>()</span><br><span class="line">   : <span class="built_in">sim_trans</span>(<span class="number">-10.0</span>,  <span class="comment">// 10x reducer. Negative sign: actuator and joint spin in opposite directions</span></span><br><span class="line">                 <span class="number">1.0</span>), <span class="comment">// joint position offset</span></span><br><span class="line"></span><br><span class="line">     <span class="built_in">dif_trans</span>(<span class="built_in">vector</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>, <span class="number">5.0</span>), <span class="comment">// 5x reducer on each actuator</span></span><br><span class="line">               <span class="built_in">vector</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>, <span class="number">1.0</span>)) <span class="comment">// No reducer in joint output</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Wrapping the raw data is the most verbose part of the setup process... //////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap simple transmission raw data - current state</span></span><br><span class="line">    a_state_data[<span class="number">0</span>].position.<span class="built_in">push_back</span>(&amp;a_curr_pos[<span class="number">0</span>]);</span><br><span class="line">    a_state_data[<span class="number">0</span>].velocity.<span class="built_in">push_back</span>(&amp;a_curr_vel[<span class="number">0</span>]);</span><br><span class="line">    a_state_data[<span class="number">0</span>].effort.<span class="built_in">push_back</span>(&amp;a_curr_eff[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    j_state_data[<span class="number">0</span>].position.<span class="built_in">push_back</span>(&amp;j_curr_pos[<span class="number">0</span>]);</span><br><span class="line">    j_state_data[<span class="number">0</span>].velocity.<span class="built_in">push_back</span>(&amp;j_curr_vel[<span class="number">0</span>]);</span><br><span class="line">    j_state_data[<span class="number">0</span>].effort.<span class="built_in">push_back</span>(&amp;j_curr_eff[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap simple transmission raw data - position command</span></span><br><span class="line">    a_cmd_data[<span class="number">0</span>].position.<span class="built_in">push_back</span>(&amp;a_cmd_pos[<span class="number">0</span>]); <span class="comment">// Velocity and effort vectors are unused</span></span><br><span class="line"></span><br><span class="line">    j_cmd_data[<span class="number">0</span>].position.<span class="built_in">push_back</span>(&amp;j_cmd_pos[<span class="number">0</span>]); <span class="comment">// Velocity and effort vectors are unused</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap differential transmission raw data - current state</span></span><br><span class="line">    a_state_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;a_curr_pos[<span class="number">1</span>]); a_state_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;a_curr_pos[<span class="number">2</span>]);</span><br><span class="line">    a_state_data[<span class="number">1</span>].velocity.<span class="built_in">push_back</span>(&amp;a_curr_vel[<span class="number">1</span>]); a_state_data[<span class="number">1</span>].velocity.<span class="built_in">push_back</span>(&amp;a_curr_vel[<span class="number">2</span>]);</span><br><span class="line">    a_state_data[<span class="number">1</span>].effort.<span class="built_in">push_back</span>(&amp;a_curr_eff[<span class="number">1</span>]);   a_state_data[<span class="number">1</span>].effort.<span class="built_in">push_back</span>(&amp;a_curr_eff[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    j_state_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;j_curr_pos[<span class="number">1</span>]); j_state_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;j_curr_pos[<span class="number">2</span>]);</span><br><span class="line">    j_state_data[<span class="number">1</span>].velocity.<span class="built_in">push_back</span>(&amp;j_curr_vel[<span class="number">1</span>]); j_state_data[<span class="number">1</span>].velocity.<span class="built_in">push_back</span>(&amp;j_curr_vel[<span class="number">2</span>]);</span><br><span class="line">    j_state_data[<span class="number">1</span>].effort.<span class="built_in">push_back</span>(&amp;j_curr_eff[<span class="number">1</span>]);   j_state_data[<span class="number">1</span>].effort.<span class="built_in">push_back</span>(&amp;j_curr_eff[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap differential transmission raw data - position command</span></span><br><span class="line">    a_cmd_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;a_cmd_pos[<span class="number">1</span>]); a_cmd_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;a_cmd_pos[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    j_cmd_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;j_cmd_pos[<span class="number">1</span>]); j_cmd_data[<span class="number">1</span>].position.<span class="built_in">push_back</span>(&amp;j_cmd_pos[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...once the raw data has been wrapped, the rest is straightforward //////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register transmissions to each interface</span></span><br><span class="line">    act_to_jnt_state.<span class="built_in">registerHandle</span>(<span class="built_in">ActuatorToJointStateHandle</span>(<span class="string">&quot;sim_trans&quot;</span>,</span><br><span class="line">                                                               &amp;sim_trans,</span><br><span class="line">                                                               a_state_data[<span class="number">0</span>],</span><br><span class="line">                                                               j_state_data[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    act_to_jnt_state.<span class="built_in">registerHandle</span>(<span class="built_in">ActuatorToJointStateHandle</span>(<span class="string">&quot;dif_trans&quot;</span>,</span><br><span class="line">                                                              &amp;dif_trans,</span><br><span class="line">                                                              a_state_data[<span class="number">1</span>],</span><br><span class="line">                                                              j_state_data[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    jnt_to_act_pos.<span class="built_in">registerHandle</span>(<span class="built_in">JointToActuatorPositionHandle</span>(<span class="string">&quot;sim_trans&quot;</span>,</span><br><span class="line">                                                                &amp;sim_trans,</span><br><span class="line">                                                                a_cmd_data[<span class="number">0</span>],</span><br><span class="line">                                                                j_cmd_data[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    jnt_to_act_pos.<span class="built_in">registerHandle</span>(<span class="built_in">JointToActuatorPositionHandle</span>(<span class="string">&quot;dif_trans&quot;</span>,</span><br><span class="line">                                                                &amp;dif_trans,</span><br><span class="line">                                                                a_cmd_data[<span class="number">1</span>],</span><br><span class="line">                                                                j_cmd_data[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Names must be unique within a single transmission interface, but a same name can be used in</span></span><br><span class="line">    <span class="comment">// multiple interfaces, as shown above</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Read actuator state from hardware</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Propagate current actuator state to joints</span></span><br><span class="line">    act_to_jnt_state.<span class="built_in">propagate</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Porpagate joint commands to actuators</span></span><br><span class="line">    jnt_to_act_pos.<span class="built_in">propagate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send actuator command to hardware</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Transmission interfaces</span></span><br><span class="line">  ActuatorToJointStateInterface    act_to_jnt_state; <span class="comment">// For propagating current actuator state to joint space</span></span><br><span class="line">  JointToActuatorPositionInterface jnt_to_act_pos;   <span class="comment">// For propagating joint position commands to actuator space</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Transmissions</span></span><br><span class="line">  SimpleTransmission       sim_trans;</span><br><span class="line">  DifferentialTransmission dif_trans;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Actuator and joint space variables: wrappers around raw data</span></span><br><span class="line">  ActuatorData a_state_data[<span class="number">2</span>]; <span class="comment">// Size 2: One per transmission</span></span><br><span class="line">  ActuatorData a_cmd_data[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  JointData j_state_data[<span class="number">2</span>];</span><br><span class="line">  JointData j_cmd_data[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Actuator and joint space variables - raw data:</span></span><br><span class="line">  <span class="comment">// The first actuator/joint are coupled through a reducer.</span></span><br><span class="line">  <span class="comment">// The last two actuators/joints are coupled through a differential.</span></span><br><span class="line">  <span class="type">double</span> a_curr_pos[<span class="number">3</span>]; <span class="comment">// Size 3: One per actuator</span></span><br><span class="line">  <span class="type">double</span> a_curr_vel[<span class="number">3</span>];</span><br><span class="line">  <span class="type">double</span> a_curr_eff[<span class="number">3</span>];</span><br><span class="line">  <span class="type">double</span> a_cmd_pos[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> j_curr_pos[<span class="number">3</span>]; <span class="comment">// Size 3: One per joint</span></span><br><span class="line">  <span class="type">double</span> j_curr_vel[<span class="number">3</span>];</span><br><span class="line">  <span class="type">double</span> j_curr_eff[<span class="number">3</span>];</span><br><span class="line">  <span class="type">double</span> j_cmd_pos[<span class="number">3</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/17/Robot/ROS/ros_control/hardware_interface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/17/Robot/ROS/ros_control/hardware_interface/" class="post-title-link" itemprop="url">hardware_interface</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-17 07:54:09" itemprop="dateCreated datePublished" datetime="2024-10-17T07:54:09+08:00">2024-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-19 09:37:05" itemprop="dateModified" datetime="2024-10-19T09:37:05+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/" itemprop="url" rel="index"><span itemprop="name">Robot</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/" itemprop="url" rel="index"><span itemprop="name">ROS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/ros-control/" itemprop="url" rel="index"><span itemprop="name">ros_control</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hardware-interfaces"><a href="#hardware-interfaces" class="headerlink" title="hardware interfaces"></a><strong>hardware interfaces</strong></h1><p>ROS control 将 hardware interfaces 与可用的 ROS controllers 之一结合使用，以向硬件发送(即: <strong>write()</strong>)命令，并从硬件接收(即: <strong>read()</strong>)关节状态。</p>
<p>可用硬件接口包括：</p>
<ul>
<li><p><strong>Joint Command Interfaces</strong></p>
<ul>
<li>Effort joint interface</li>
<li>Velocity joint interface</li>
<li>Position joint interface</li>
</ul>
</li>
<li><p><strong>Joint state interfaces</strong>: 读取指定关节的状态，包括:位置、速度、effort 等</p>
</li>
<li><p><strong>Actuator state interfaces</strong> （执行器&#x2F;驱动器状态接口）</p>
</li>
<li><p><strong>Actuator Command Interfaces</strong></p>
<ul>
<li>Effort Actuator Interface</li>
<li>Velocity Actuator Interface</li>
<li>Position Actuator Interface</li>
</ul>
</li>
<li><p><strong>Force-torque sensor interface</strong> （力 - 扭矩传感器接口）</p>
</li>
<li><p><strong>IMU sensor interface</strong></p>
</li>
</ul>
<h2 id="设置新的机器人"><a href="#设置新的机器人" class="headerlink" title="设置新的机器人"></a><strong>设置新的机器人</strong></h2><img src="/2024/10/17/Robot/ROS/ros_control/hardware_interface/image-20241016080542208.png" class="" title="image-20241016080542208">

<h2 id="使用现有接口"><a href="#使用现有接口" class="headerlink" title="使用现有接口"></a><strong>使用现有接口</strong></h2><p>假设机器人有两个关节：A 和 B。两个关节都是位置控制。这种情况下，为机器人定义的 hardware_interface::RobotHW，应提供标准的 <strong>JointPositionInterface</strong> 和 <strong>JointStateInterface</strong>，以便可以重用所有已编写好的、使用 JointPositionInterface 和 JointStateInterface 的 controllers。例如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hardware_interface/joint_command_interface.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hardware_interface/joint_state_interface.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hardware_interface/robot_hw.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyRobot</span> : <span class="keyword">public</span> hardware_interface::RobotHW</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MyRobot</span>() </span><br><span class="line"> &#123; </span><br><span class="line">   <span class="comment">// connect and register the joint state interface</span></span><br><span class="line">   <span class="comment">// JointstateHandle为关节状态的资源类，其内部存储有：pos，vel，effort的获取接口</span></span><br><span class="line">   <span class="function">hardware_interface::JointStateHandle <span class="title">state_handle_a</span><span class="params">(<span class="string">&quot;A&quot;</span>, &amp;pos[<span class="number">0</span>], &amp;vel[<span class="number">0</span>], &amp;eff[<span class="number">0</span>])</span></span>;</span><br><span class="line">   <span class="comment">// ResourceManager 注册新的资源，如果资源名已存在，则覆盖之前的</span></span><br><span class="line">   jnt_state_interface.<span class="built_in">registerHandle</span>(state_handle_a);</span><br><span class="line"></span><br><span class="line">   <span class="function">hardware_interface::JointStateHandle <span class="title">state_handle_b</span><span class="params">(<span class="string">&quot;B&quot;</span>, &amp;pos[<span class="number">1</span>], &amp;vel[<span class="number">1</span>], &amp;eff[<span class="number">1</span>])</span></span>;</span><br><span class="line">   jnt_state_interface.<span class="built_in">registerHandle</span>(state_handle_b);</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// 注册硬件接口 </span></span><br><span class="line">   <span class="built_in">registerInterface</span>(&amp;jnt_state_interface);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// connect and register the joint position interface</span></span><br><span class="line">   <span class="function">hardware_interface::JointHandle <span class="title">pos_handle_a</span><span class="params">(jnt_state_interface.getHandle(<span class="string">&quot;A&quot;</span>), &amp;cmd[<span class="number">0</span>])</span></span>;</span><br><span class="line">   jnt_pos_interface.<span class="built_in">registerHandle</span>(pos_handle_a);</span><br><span class="line"></span><br><span class="line">   <span class="function">hardware_interface::JointHandle <span class="title">pos_handle_b</span><span class="params">(jnt_state_interface.getHandle(<span class="string">&quot;B&quot;</span>), &amp;cmd[<span class="number">1</span>])</span></span>;</span><br><span class="line">   jnt_pos_interface.<span class="built_in">registerHandle</span>(pos_handle_b);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">registerInterface</span>(&amp;jnt_pos_interface);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  hardware_interface::JointStateInterface jnt_state_interface;</span><br><span class="line">  hardware_interface::PositionJointInterface jnt_pos_interface;</span><br><span class="line">  <span class="type">double</span> cmd[<span class="number">2</span>];</span><br><span class="line">  <span class="type">double</span> pos[<span class="number">2</span>];</span><br><span class="line">  <span class="type">double</span> vel[<span class="number">2</span>];</span><br><span class="line">  <span class="type">double</span> eff[<span class="number">2</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面的功能旨在使 controller manager（以及 controller manager 内部的 controllers）可以访问机器人的关节状态以及机器人的命令。当 controller manager 运行时，<strong>controllers 将从机器人读取 pos，vel 和 eff 变量; 且会将所需的命令写入 cmd 变量</strong>。<strong>使用者需确保 pos，vel 和 eff 变量始终具有最新的可用关节状态，并且还需要确保写入到 cmd 变量中的所有内容都由机器人执行</strong>。例如，可以为 robot 类定义 read() 及 write() 函数，然后在 main() 中调用这些函数确保数据是最新的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">main</span>()</span><br><span class="line">&#123;</span><br><span class="line">  MyRobot robot;</span><br><span class="line">  <span class="function">controller_manager::ControllerManager <span class="title">cm</span><span class="params">(&amp;robot)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  &#123;</span><br><span class="line">     robot.<span class="built_in">read</span>();</span><br><span class="line">     cm.<span class="built_in">update</span>(robot.<span class="built_in">get_time</span>(), robot.<span class="built_in">get_period</span>());</span><br><span class="line">     robot.<span class="built_in">write</span>();</span><br><span class="line">     <span class="built_in">sleep</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="创建机器人特定接口"><a href="#创建机器人特定接口" class="headerlink" title="创建机器人特定接口"></a><strong>创建机器人特定接口</strong></h2><p>对于标准的机器人特性，可以使用标准接口(并重用标准 controllers)。与此同时，可以在特定于机器人的接口中公开特定于机器人的特性。</p>
<p>自定义接口代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyRobot</span> : <span class="keyword">public</span> hardware_interface::RobotHW</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MyRobot</span>() </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// register the joint state and position interfaces</span></span><br><span class="line">    ...</span><br><span class="line">    ... (see the code above)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// register some robot specific interfaces</span></span><br><span class="line">    <span class="built_in">registerInterface</span>(&amp;cool_interface);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    MyCustomInterface cool_interface;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>或者，也可以注册 MyRobot 类自身：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyRobot</span> : <span class="keyword">public</span> hardware_interface::RobotHW, <span class="keyword">public</span> hardware_interface::HardwareInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MyRobot</span>() </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// register the joint state and position interfaces</span></span><br><span class="line">    ...</span><br><span class="line">    ... (see the code above)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// register the MyRobot class itself to make the &#x27;someCoolFunction&#x27; available</span></span><br><span class="line">    <span class="comment">// the MyRobot class inherits from HardwareInterface to make this possible</span></span><br><span class="line">    <span class="built_in">registerInterface</span>(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">someCoolFunction</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>因此，自定义接口无非就是向该机器人类添加任意数量的函数调用，以及注册机器人类本身。这些特定于机器人的功能仅适用于专门为该机器人设计的控制器，但与此同时，该机器人仍可使用标准接口与标准 controllers 一起工作。</p>
<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a><strong>资源管理</strong></h2><p>controller manager 跟踪每个 controller 正在使用的资源。资源可以是诸如 ‘right_elbow_joint’， ‘base’， ‘left_arm’， ‘腕关节’ 等。<strong>资源在硬件接口中指定</strong>。例如，PositionJointInterface 使用关节名作为资源。用户可自定义 hardware interface，并定义自己的资源。控制器初始化时，从硬件接口请求大量资源；这些请求由控制器管理器记录。因此，控制器管理器确切的知道哪个控制器请求了哪些资源。</p>
<p>RobotHW 具有用于资源管理的简单默认实现：它只简单的防止使用相同资源的两个控制器同时运行。请注意，<strong>使用相同资源的两个控制器可以同时加载，但不能同时运行</strong>。如果此简单的资源管理方案适合您的机器人，则无需执行任何操作，控制器管理器将自动应用此方案。如果您的机器人需要其他方案，则可以通过实现一个功能轻松创建自己的方案：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyRobot</span> : <span class="keyword">public</span> hardware_interface::RobotHW</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MyRobot</span>() </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// register hardware interfaces interfaces</span></span><br><span class="line">    ...</span><br><span class="line">    ... (see the code above)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Implement robot-specific resouce management</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkForConflict</span><span class="params">(<span class="type">const</span> std::list&lt;ControllerInfo&gt;&amp; info)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       <span class="comment">// this list of controllers cannot be running at the same time</span></span><br><span class="line">       ... </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// this list of controller can be running at the same time</span></span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>checkForConflict 方法的输入是 controller info objects 列表。这些对象中的每一个都与一个控制器匹配，并包含有关该控制器的所有信息。 此信息包括控制器名称，控制器类型，硬件接口类型以及控制器要求的资源列表。根据所有这些信息，用户可以提出自己的方案来确定是否允许同时运行给定的控制器列表。</p>
<h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a><strong>综述</strong></h2><p>通常，对于真实机器人，需要做的有：</p>
<ul>
<li>编写硬件接口(hardware_interface)，读取设备驱动返回的关节状态 </li>
<li>编写设备驱动，发布关节状态，如编码器脉冲，位置等</li>
</ul>
<h1 id="hardware-resource"><a href="#hardware-resource" class="headerlink" title="hardware resource"></a>hardware resource</h1><p><img src="D:\workspace\my-notes\myblog\source_posts\Robot\ROS\ros_control\hardware_interface\image-20241017074356284.png" alt="image-20241017074356284"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 硬件资源封装在 handle 实例内，该类允许通过名称注册和获取它们。</span></span><br><span class="line"><span class="comment"> * 也可以通过 ClaimPolicy 模板参数指定是否获取句柄 claims 对应资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">ResourceHandle</span>, <span class="keyword">class</span> <span class="title class_">ClaimPolicy</span> = DontClaimResources&gt;</span><br><span class="line"><span class="keyword">class</span> HardwareResourceManager : <span class="keyword">public</span> HardwareInterface, <span class="keyword">public</span> ResourceManager&lt;ResourceHandle&gt;</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If unspecified,the resource manager will not claim resources(若未指定，资源管理器将不会声明资源)</span></span><br><span class="line">&#123;</span><br><span class="line">  HardwareResourceManager&lt;JointStateHandle&gt; m;</span><br><span class="line">  <span class="comment">// 填充 m</span></span><br><span class="line">  m.<span class="built_in">getHandle</span>(<span class="string">&quot;handle_name&quot;</span>); <span class="comment">// DOES NOT claim the &quot;handle_name&quot; resource</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Explicitly set ClaimPolicy to DontClaimResources</span></span><br><span class="line">&#123;</span><br><span class="line">  HardwareResourceManager&lt;JointStateHandle, DontClaimResources&gt; m;</span><br><span class="line">  <span class="comment">// Populate m(填充 m)</span></span><br><span class="line">  m.<span class="built_in">getHandle</span>(<span class="string">&quot;handle_name&quot;</span>); <span class="comment">// DOES NOT claim the &quot;handle_name&quot; resource</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Explicitly set ClaimPolicy to ClaimResources</span></span><br><span class="line">&#123;</span><br><span class="line">  HardwareResourceManager&lt;JointHandle, ClaimResources&gt; m;</span><br><span class="line">  <span class="comment">// Populate m</span></span><br><span class="line">  m.<span class="built_in">getHandle</span>(<span class="string">&quot;handle_name&quot;</span>); <span class="comment">// DOES claim the &quot;handle_name&quot; resource</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/17/Robot/ROS/ros_control/ros_control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/17/Robot/ROS/ros_control/ros_control/" class="post-title-link" itemprop="url">ros_control</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-17 07:36:57" itemprop="dateCreated datePublished" datetime="2024-10-17T07:36:57+08:00">2024-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-19 09:37:12" itemprop="dateModified" datetime="2024-10-19T09:37:12+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/" itemprop="url" rel="index"><span itemprop="name">Robot</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/" itemprop="url" rel="index"><span itemprop="name">ROS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/ros-control/" itemprop="url" rel="index"><span itemprop="name">ros_control</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>由 PR2 改写而来的硬件封装库，负责统一管理硬件设备与底层细节，向上提供统一的接口（用户需继承 <code>hardware_interface::RobotHW</code>，实现并调用 <code>read/write</code> 等方法）。包括控制器接口、控制器管理器、传输和硬件接口的包，可以帮助机器人应用快速落地，提高开发效率。</p>
<img src="/2024/10/17/Robot/ROS/ros_control/ros_control/image-20241017074020125.png" class="" title="image-20241017074020125">

<ul>
<li>Controller Manager：管理不同的 controller</li>
<li>Controller：可以实现 joints 的控制，请求硬件资源，读取硬件资源接口中的状态，发布控制命令</li>
<li>Harware Resource：硬件资源</li>
<li>RobotHW：硬件抽象层，用户需继承该类，实现  方法，来实现机器人的操作</li>
<li>Real Robot：真实机器人硬件，接收并响应指令，反馈状态等</li>
</ul>
<p>使用 ros_control 能够复用 ros_controllers 中的控制算法，并且对 gazebo 支持良好。（gazebo 仿真时，自定义插件需继承自 <code>gazebo_ros_control::RobotHWSim</code>，该类实现了模拟 ros_control 中的 <code>hardware_interface::RobotHW</code>） </p>
<img src="/2024/10/17/Robot/ROS/ros_control/ros_control/image-20241017074223274.png" class="" title="image-20241017074223274">

<blockquote>
<p>存在问题：部分模块冗余严重，架构过于复杂</p>
</blockquote>
<p>提供了一个硬件抽象层，负责机器人硬件资源的管理。controller 则从中请求资源即可。</p>
<img src="/2024/10/17/Robot/ROS/ros_control/ros_control/image-20241017074249079.png" class="" title="image-20241017074249079">

<img src="/2024/10/17/Robot/ROS/ros_control/ros_control/image-20241017074305429.png" class="" title="image-20241017074305429">

<img src="/2024/10/17/Robot/ROS/ros_control/ros_control/image-20241017074326664.png" class="" title="image-20241017074326664">



<h1 id="hardware-interface"><a href="#hardware-interface" class="headerlink" title="hardware interface"></a>hardware interface</h1><p>机器人的硬件抽象，相当于机器人的软件表示。是 ros_control 和实体机器人沟通的桥梁。hardware interface 的功能包括向实体机器人发送指令；从机器人驱动读取机器人状态。</p>
<p>ros control 中包含了一系列可用的硬件接口（通过硬件资源管理器）。ROS control 将硬件接口与上述的 ROS controllers 之一结合使用，以向硬件发送和接受命令。以下是当前支持的硬件接口：</p>
<ul>
<li><strong>Joint Command Interfaces</strong><ul>
<li>Effort joint interface</li>
<li>Velocity joint interface</li>
<li>Position joint interface</li>
</ul>
</li>
<li><strong>Joint state interfaces</strong></li>
<li><strong>Actuator state interfaces</strong> （执行器&#x2F;驱动器状态接口）</li>
<li><strong>Actuator Command Interfaces</strong><ul>
<li>Effort Actuator Interface</li>
<li>Velocity Actuator Interface</li>
<li>Position Actuator Interface</li>
</ul>
</li>
<li><strong>Force-torque sensor interface</strong> （力 - 扭矩传感器接口）</li>
<li><strong>IMU sensor interface</strong></li>
</ul>
<h1 id="Transmission（传动装置）"><a href="#Transmission（传动装置）" class="headerlink" title="Transmission（传动装置）"></a>Transmission（传动装置）</h1><p>transmissions 是 control pipeline 中的一个元素，转换efforts(力&#x2F;电压等)&#x2F;flow(速度&#x2F;电流等)变量，使产品功率保持不变。</p>
<p>机械传动是功率不变的变换，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P_in    = P_out </span><br><span class="line">F_in x V_in = F_out x V_out   </span><br></pre></td></tr></table></figure>

<p>P、F、V分别代表 power、force(力度)和速度。power 是effort(如:force&#x2F;voltage) 变量和 flow 变量(如:velocity&#x2F;current)的作用结果。</p>
<p>例如，对于减速比为 n 的简单机械减速器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">effort map: F_joint = F_actuator * n</span><br><span class="line">flow map: V_joint = V_actuator / n</span><br></pre></td></tr></table></figure>

<p><strong>transmission URDF格式</strong></p>
<p><a target="_blank" rel="noopener" href="http://wiki.ros.org/urdf/XML/Transmission">参考</a></p>
<p><strong>transmission接口</strong></p>
<p>Transmission-specific 代码通过一个 transmission 类型共享的通用接口实现双向（actuator &lt;-&gt; joint）effort 和 flow 之间的映射。可用的 transmission 接口：</p>
<ul>
<li>Simple Reduction Transmission（简单减速装置）</li>
<li>Differential Transmission（差分传动）</li>
<li>Four Bar Linkage Transmission（四杆传动）</li>
</ul>
<p>用法：</p>
<ul>
<li><code>transmission_interface::ActuatorToJointStateInterface</code>：通过 actuator 变量设置关节状态</li>
<li><code>hardware_interface::JointStateInterface</code>：将关节状态暴露给控制器</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/ros-controls/ros_control/wiki/transmission_interface">示例</a></p>
<h1 id="关节限制"><a href="#关节限制" class="headerlink" title="关节限制"></a><strong>关节限制</strong></h1><p>joint_limits_interface 包含用于表示关节限制的数据结构、用于从诸如 URDF 和 rosparam 的通用格式填充它们的方法，以及用于对不同类型的关节命令实施限制的方法。</p>
<p>控制器本身不使用 Joint_limits_interface(它不实现 HardwareInterface)，而是在控制器更新之后在机器人抽象的 write()方法（或等效方法）中操作。Enforcing limits 将覆盖控制器下发的指令，它不会在单独的原始数据缓冲区上操作。</p>
<p><strong>说明</strong></p>
<p>①. <strong>Joint limits</strong> Position, velocity, acceleration, jerk and effort.</p>
<p>②. <strong>Soft joint limits</strong> Soft position limits, k_p, k_v (as described in pr2_controller_manager&#x2F;safety_limits).</p>
<p>③. Utility method for loading joint limits information from URDF (only position, velocity, effort)</p>
<p>④. Utility method for loading soft joint limits information from URDF</p>
<p>⑤. Utility method for loading joint limits from ROS parameter server (all values). Parameter specification is the same used in MoveIt, with the addition that we also parse jerk and effort limits.</p>
<p><strong>关节限制接口</strong></p>
<p>①. ros_control 接口用于执行关节限制</p>
<p>②. 对于 effort-controlled joints, position-controlled joints, 以及velocity-controlled joints,创建了两类接口。一类是饱和（saturation）接口，用于有普通限制而没有软限制的关节；另一类是实现了软限制的接口，与PR2中使用的类似。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ros-controls/ros_control/wiki/joint_limits_interface">示例</a></p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h1><ul>
<li><ul>
<li>Barrett WAM controllers at Johns Hopkins University: <a target="_blank" rel="noopener" href="https://github.com/jhu-lcsr/barrett_control">barrett_control on Github</a></li>
<li>RRBot in Gazebo: <a target="_blank" rel="noopener" href="http://gazebosim.org/tutorials/?tut=ros_control">ros_control with Gazebo tutorial</a></li>
<li>Rethink Baxter hardware as used at the University of Colorado Boulder: <a target="_blank" rel="noopener" href="https://github.com/davetcoleman/baxter_cpp/blob/hydro-devel/baxter_control/src/baxter_hardware_interface.cpp">Baxter on Github</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/16/Robot/ROS/ros_control/joint_trajectory_controller/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/16/Robot/ROS/ros_control/joint_trajectory_controller/" class="post-title-link" itemprop="url">joint_trajectory_controller</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-16 08:08:48" itemprop="dateCreated datePublished" datetime="2024-10-16T08:08:48+08:00">2024-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-19 09:37:08" itemprop="dateModified" datetime="2024-10-19T09:37:08+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/" itemprop="url" rel="index"><span itemprop="name">Robot</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/" itemprop="url" rel="index"><span itemprop="name">ROS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/ros-control/" itemprop="url" rel="index"><span itemprop="name">ros_control</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h1><p>在一组关节上执行关节空间轨迹(<strong>joint-space trajectories</strong>)的控制器。轨迹被指定为在特定时刻到达的一组 waypoints，控制器试图在允许的情况下执行这些 waypoints。waypoints 由位置、可选速度和加速度组成。</p>
<p>该控制器被模板化以处理多个轨迹表示。默认情况下，提供了**样条插值器(spline interpolator)**。样条插值器根据 waypoint 规范使用以下插值策略:</p>
<ul>
<li><strong>Linear</strong>：线性插值。只指定了位置。保证位置的连续性。不理想，因为它会产生速度不连续的轨迹在路径点</li>
<li><strong>Cubic</strong>：指定了位置和速度。保证速度层级上的连续性</li>
<li><strong>Quintic</strong>：指定位置，速度和加速度被。保证在加速度层级上的连续性</li>
</ul>
<p>controller 类型包括：</p>
<ul>
<li>速度控制：<strong>velocity_controllers</strong>&#x2F;JointTrajectoryController</li>
<li>位置控制：<strong>position_controllers</strong>&#x2F;JointTrajectoryController</li>
<li>effort 控制：<strong>effort_controllers</strong>&#x2F;JointTrajectoryController</li>
<li>…</li>
</ul>
<h2 id="Hardware-interface-type"><a href="#Hardware-interface-type" class="headerlink" title="Hardware interface type"></a><strong>Hardware interface type</strong></h2><p>控制器被模板化以使用多种硬件接口类型。目前支持具有<strong>位置</strong>、<strong>速度</strong>和<strong>力</strong>接口的关节</p>
<ul>
<li>位置控制的关节(<strong>position-controlled joints</strong>)，只需将所需位置转发给关节</li>
<li>速度（力）关节(<strong>velocity&#x2F;effort joints</strong>)，包含位置+速度的轨迹跟随误差通过 PID 回路映射到速度（力）命令</li>
</ul>
<p>与上面的轨迹表示案例类似，可以支持新的硬件接口，或对已支持接口的替代映射（例如，用于生成努力命令的代理控制器）。</p>
<h2 id="其它特性"><a href="#其它特性" class="headerlink" title="其它特性"></a><strong>其它特性</strong></h2><ul>
<li>Realtime-safe</li>
<li>正确处理 wrapping(连续)关节</li>
<li>Robuster to system clock changes：不连续的系统时钟更改不会导致已经排队的轨迹段执行的不连续。</li>
</ul>
<h1 id="发送轨迹"><a href="#发送轨迹" class="headerlink" title="发送轨迹"></a><strong>发送轨迹</strong></h1><h2 id="可用接口"><a href="#可用接口" class="headerlink" title="可用接口"></a><strong>可用接口</strong></h2><p>有两种机制将<strong>轨迹发送到控制器</strong>：</p>
<ul>
<li>通过 action interface</li>
<li>通过 topic interface</li>
</ul>
<p>两者都使用 <a target="_blank" rel="noopener" href="http://docs.ros.org/en/api/trajectory_msgs/html/msg/JointTrajectory.html">trajectory_msgs&#x2F;JointTrajectory</a> 类型来描述轨迹。并且，若 <strong>allow_partial_joints_goal</strong> 未设置为 True，则需要为所有控制器关节指定值。</p>
<p>发送轨迹的主要方式是通过 action interface。Action goals 不仅可以指定要执行的轨迹，还可以（可选）指定路径和目标容差。如果未指定公差，则使用参数服务器中给出的默认值。如果在轨迹执行期间违反了容差，则中止 action goal 并通知客户端。</p>
<p>注意: <strong>即使目标已中止，控制器仍会尝试尽可能最佳地执行轨迹</strong>。</p>
<p>topic interface 是一种即发即弃(fire-and-forget)的替代方案。在这种情况下不使用控制器的路径和目标容差规范，因为没有机制来通知发送者有关容差违规的情况。请注意，虽然可以通过 query_state 服务和状态主题进行一定程度的监控，但实现起来比使用操作接口要麻烦得多。</p>
<h2 id="preemption-policy"><a href="#preemption-policy" class="headerlink" title="preemption policy"></a><strong>preemption policy</strong></h2><p>抢占策略。</p>
<p>任何时候只能激活一个 action goal。仅针对活动目标的轨迹段检查路径和目标容差。</p>
<p>当一个活动的 action goal 被来自 action 或 topic interface 的另一个命令抢占时，该目标被取消并通知客户端。</p>
<p><strong>从 topic interface 发送空轨迹消息将停止所有排队轨迹的执行并进入位置保持模式</strong>。<strong>stop_trajectory_duration</strong> 参数控制停止运动的持续时间。</p>
<h2 id="trajectory-replacement"><a href="#trajectory-replacement" class="headerlink" title="trajectory replacement"></a><strong>trajectory replacement</strong></h2><p>关节轨迹消息允许通过 header 中的时间戳指定新轨迹应该开始执行的时间，其中零时间（默认值）表示“现在开始”。</p>
<p>新轨迹命令的到来并不一定意味着控制器将完全丢弃当前运行的轨迹并用新的轨迹代替。相反，控制器将采用两者的有用部分并将它们适当地组合起来。 有关此行为的详细说明，参考：<a target="_blank" rel="noopener" href="http://wiki.ros.org/joint_trajectory_controller/UnderstandingTrajectoryReplacement">understanding trajectory replacement</a>。</p>
<h1 id="参数及接口"><a href="#参数及接口" class="headerlink" title="参数及接口"></a><strong>参数及接口</strong></h1><p><strong>1）Action interface</strong></p>
<p>该控制器在控制器的 <strong>follow_joint_trajectory</strong> 命名空间中发布  control_msgs::FollowJointTrajectoryAction 类型的接口。</p>
<p><strong>2）订阅主题</strong></p>
<ul>
<li><strong>command</strong>：类型 trajectory_msgs&#x2F;JointTrajectory。使用 Topic 接口发布的要执行的轨迹</li>
</ul>
<p><strong>3）发布主题</strong></p>
<ul>
<li><strong>state</strong>：类型 control_msgs&#x2F;JointTrajectoryControllerState。发布控制器的当前状态</li>
</ul>
<p><strong>4）Services</strong></p>
<ul>
<li>query_state：类型 control_msgs&#x2F;QueryTrajectoryState，查询控制器状态</li>
</ul>
<p><strong>5）参数</strong></p>
<ul>
<li><strong>joints</strong>：类型 string[]。被控制的关节列表</li>
<li><strong>constraints&#x2F;goal_time</strong>：如果目标轨迹点的时间戳为 t，则如果在 t ± goal_time 内到达目标，则轨迹成功，否则中止</li>
<li><strong>constraints&#x2F;stopped_velocity_tolerance</strong>：速度被认为近似等于零</li>
<li><strong>constraints&#x2F;&#x2F;goal</strong>：指定关节达到目标的位置公差。当关节在 goal_position ± goal_tolerance 范围内时，轨迹可以成功</li>
<li><strong>constraints&#x2F;&#x2F;trajectory</strong>：整个轨迹中指定关节的位置公差。如果关节位置超出 trajectory_position +&#x2F;- tolerance，则轨迹中止</li>
<li>**gains&#x2F;**：指定 PID 控制器的参数值</li>
<li>**velocity_ff&#x2F;**：添加到 PID 控制器输出的速度前馈项(feed-forward)的增益。可选，仅由 effort 和速度接口使用</li>
<li><strong>stop_trajectory_duration</strong>：启动控制器或取消轨迹时，会进入位置保持模式。此参数指定使当前状态（位置和速度）停止所需的时间。 它的值可以大于或等于零</li>
<li><strong>state_publish_rate</strong>：控制器状态发布速率</li>
<li><strong>action_monitor_rate</strong>：监控 action goal 的频率（以赫兹为单位）。这是一个不需要更改的高级参数</li>
<li><strong>allow_partial_joints_goal</strong>：允许发布带有部分关节集的 JointTrajectory 消息</li>
</ul>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h1><p>1）最小描述，位置接口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">head_controller:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;position_controllers/JointTrajectoryController&quot;</span></span><br><span class="line">  <span class="attr">joints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_1_joint</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_2_joint</span></span><br></pre></td></tr></table></figure>

<p>2）最小描述，速度接口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">head_controller:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;velocity_controllers/JointTrajectoryController&quot;</span></span><br><span class="line">  <span class="attr">joints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_1_joint</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_2_joint</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">gains:</span> <span class="comment"># Required because we&#x27;re controlling a velocity interface</span></span><br><span class="line">    <span class="attr">head_1_joint:</span> &#123;<span class="attr">p:</span> <span class="number">100</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125;</span><br><span class="line">    <span class="attr">head_2_joint:</span> &#123;<span class="attr">p:</span> <span class="number">100</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<p>3）Velocity FF，速度接口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">head_controller:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;velocity_controllers/JointTrajectoryController&quot;</span></span><br><span class="line">  <span class="attr">joints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_1_joint</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_2_joint</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">gains:</span> <span class="comment"># Required because we&#x27;re controlling a velocity interface</span></span><br><span class="line">    <span class="attr">head_1_joint:</span> &#123;<span class="attr">p:</span> <span class="number">10</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125; <span class="comment"># Smaller &#x27;p&#x27; term, since ff term does most of the work</span></span><br><span class="line">    <span class="attr">head_2_joint:</span> &#123;<span class="attr">p:</span> <span class="number">10</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125; <span class="comment"># Smaller &#x27;p&#x27; term, since ff term does most of the work</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">velocity_ff:</span></span><br><span class="line">    <span class="attr">head_1_joint:</span> <span class="number">1.0</span></span><br><span class="line">    <span class="attr">head_2_joint:</span> <span class="number">1.0</span></span><br></pre></td></tr></table></figure>

<p>4）最小描述，effort 接口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">head_controller:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;effort_controllers/JointTrajectoryController&quot;</span></span><br><span class="line">  <span class="attr">joints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_1_joint</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_2_joint</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">gains:</span> <span class="comment"># Required because we&#x27;re controlling an effort interface</span></span><br><span class="line">    <span class="attr">head_1_joint:</span> &#123;<span class="attr">p:</span> <span class="number">100</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125;</span><br><span class="line">    <span class="attr">head_2_joint:</span> &#123;<span class="attr">p:</span> <span class="number">100</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<p>5）完整示例，effort 接口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">head_controller:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;effort_controllers/JointTrajectoryController&quot;</span></span><br><span class="line">  <span class="attr">joints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_1_joint</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">head_2_joint</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">constraints:</span></span><br><span class="line">    <span class="attr">goal_time:</span> <span class="number">0.5</span>                   <span class="comment"># Override default</span></span><br><span class="line">    <span class="attr">stopped_velocity_tolerance:</span> <span class="number">0.02</span> <span class="comment"># Override default</span></span><br><span class="line">    <span class="attr">head_1_joint:</span></span><br><span class="line">      <span class="attr">trajectory:</span> <span class="number">0.05</span>               <span class="comment"># Not enforced if unspecified</span></span><br><span class="line">      <span class="attr">goal:</span> <span class="number">0.02</span>                     <span class="comment"># Not enforced if unspecified</span></span><br><span class="line">    <span class="attr">head_2_joint:</span></span><br><span class="line">      <span class="attr">goal:</span> <span class="number">0.01</span>                     <span class="comment"># Not enforced if unspecified</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">gains:</span> <span class="comment"># Required because we&#x27;re controlling an effort interface</span></span><br><span class="line">    <span class="attr">head_1_joint:</span> &#123;<span class="attr">p:</span> <span class="number">100</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125;</span><br><span class="line">    <span class="attr">head_2_joint:</span> &#123;<span class="attr">p:</span> <span class="number">100</span>,  <span class="attr">d:</span> <span class="number">1</span>, <span class="attr">i:</span> <span class="number">1</span>, <span class="attr">i_clamp:</span> <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">state_publish_rate:</span>  <span class="number">25</span>            <span class="comment"># Override default</span></span><br><span class="line">  <span class="attr">action_monitor_rate:</span> <span class="number">30</span>            <span class="comment"># Override default</span></span><br><span class="line">  <span class="attr">stop_trajectory_duration:</span> <span class="number">0</span>        <span class="comment"># Override default</span></span><br></pre></td></tr></table></figure>



<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a><strong>源码</strong></h1><p><code>JointTrajectoryController::init</code> 接口</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">SegmentImpl</span>, <span class="keyword">class</span> <span class="title class_">HardwareInterface</span>&gt;</span><br><span class="line"><span class="type">bool</span> JointTrajectoryController&lt;SegmentImpl, HardwareInterface&gt;::<span class="built_in">init</span>(</span><br><span class="line">        HardwareInterface* hw,</span><br><span class="line">        ros::NodeHandle&amp;   root_nh,</span><br><span class="line">        ros::NodeHandle&amp;   controller_nh)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">namespace</span> internal;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存控制器节点句柄</span></span><br><span class="line">  controller_nh_ = controller_nh;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取控制器名称</span></span><br><span class="line">  name_ = <span class="built_in">getLeafNamespace</span>(controller_nh_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 状态发布速率</span></span><br><span class="line">  <span class="type">double</span> state_publish_rate = <span class="number">50.0</span>;</span><br><span class="line">  controller_nh_.<span class="built_in">getParam</span>(<span class="string">&quot;state_publish_rate&quot;</span>, state_publish_rate);</span><br><span class="line">  <span class="built_in">ROS_DEBUG_STREAM_NAMED</span>(name_, <span class="string">&quot;Controller state will be published at &quot;</span> &lt;&lt; state_publish_rate &lt;&lt; <span class="string">&quot;Hz.&quot;</span>);</span><br><span class="line">  state_publisher_period_ = ros::<span class="built_in">Duration</span>(<span class="number">1.0</span> / state_publish_rate);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Action status checking update rate</span></span><br><span class="line">  <span class="type">double</span> action_monitor_rate = <span class="number">20.0</span>;</span><br><span class="line">  controller_nh_.<span class="built_in">getParam</span>(<span class="string">&quot;action_monitor_rate&quot;</span>, action_monitor_rate);</span><br><span class="line">  action_monitor_period_ = ros::<span class="built_in">Duration</span>(<span class="number">1.0</span> / action_monitor_rate);</span><br><span class="line">  <span class="built_in">ROS_DEBUG_STREAM_NAMED</span>(name_, <span class="string">&quot;Action status changes will be monitored at &quot;</span> &lt;&lt; action_monitor_rate &lt;&lt; <span class="string">&quot;Hz.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Stop trajectory duration</span></span><br><span class="line">  stop_trajectory_duration_ = <span class="number">0.0</span>;</span><br><span class="line">  controller_nh_.<span class="built_in">getParam</span>(<span class="string">&quot;stop_trajectory_duration&quot;</span>, stop_trajectory_duration_);</span><br><span class="line">  <span class="built_in">ROS_DEBUG_STREAM_NAMED</span>(name_, <span class="string">&quot;Stop trajectory has a duration of &quot;</span> &lt;&lt; stop_trajectory_duration_ &lt;&lt; <span class="string">&quot;s.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Checking if partial trajectories are allowed</span></span><br><span class="line">  controller_nh_.<span class="built_in">param</span>&lt;<span class="type">bool</span>&gt;(<span class="string">&quot;allow_partial_joints_goal&quot;</span>, allow_partial_joints_goal_, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">if</span> (allow_partial_joints_goal_)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_DEBUG_NAMED</span>(name_, <span class="string">&quot;Goals with partial set of joints are allowed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制的关节列表. 通过读取 /&lt;node name&gt;/joints 参数获取节点列表</span></span><br><span class="line">  joint_names_ = <span class="built_in">getStrings</span>(controller_nh_, <span class="string">&quot;joints&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (joint_names_.<span class="built_in">empty</span>()) &#123;<span class="keyword">return</span> <span class="literal">false</span>;&#125; <span class="comment">// 若节点列表为空则退出</span></span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> n_joints = joint_names_.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// URDF joints. 读取 robot_description 参数</span></span><br><span class="line">  urdf::ModelSharedPtr urdf = <span class="built_in">getUrdf</span>(root_nh, <span class="string">&quot;robot_description&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!urdf) &#123;<span class="keyword">return</span> <span class="literal">false</span>;&#125;</span><br><span class="line">  <span class="comment">// 在 URDF 中查找控制关节</span></span><br><span class="line">  std::vector&lt;urdf::JointConstSharedPtr&gt; urdf_joints = <span class="built_in">getUrdfJoints</span>(*urdf, joint_names_);</span><br><span class="line">  <span class="keyword">if</span> (urdf_joints.<span class="built_in">empty</span>()) &#123;<span class="keyword">return</span> <span class="literal">false</span>;&#125; <span class="comment">// 若 URDF 中未定义控制关节，则退出</span></span><br><span class="line">  <span class="built_in">assert</span>(n_joints == urdf_joints.<span class="built_in">size</span>()); <span class="comment">// 确定在 URDF 中找到了所有控制关节</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize members</span></span><br><span class="line">  joints_.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">  angle_wraparound_.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">  <span class="comment">// 遍历控制关节列表，获取 joint handle</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; n_joints; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Joint handle</span></span><br><span class="line">    <span class="keyword">try</span> &#123;joints_[i] = hw-&gt;<span class="built_in">getHandle</span>(joint_names_[i]);&#125;</span><br><span class="line">    <span class="built_in">catch</span> (...)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">ROS_ERROR_STREAM_NAMED</span>(name_, <span class="string">&quot;Could not find joint &#x27;&quot;</span> &lt;&lt; joint_names_[i] &lt;&lt; <span class="string">&quot;&#x27; in &#x27;&quot;</span> &lt;&lt;</span><br><span class="line">                                    <span class="keyword">this</span>-&gt;<span class="built_in">getHardwareInterfaceType</span>() &lt;&lt; <span class="string">&quot;&#x27;.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Whether a joint is continuous (ie. has angle wraparound)</span></span><br><span class="line">    angle_wraparound_[i] = urdf_joints[i]-&gt;type == urdf::Joint::CONTINUOUS;</span><br><span class="line">    <span class="type">const</span> std::string not_if = angle_wraparound_[i] ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;non-&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ROS_DEBUG_STREAM_NAMED</span>(name_, <span class="string">&quot;Found &quot;</span> &lt;&lt; not_if &lt;&lt; <span class="string">&quot;continuous joint &#x27;&quot;</span> &lt;&lt; joint_names_[i] &lt;&lt; <span class="string">&quot;&#x27; in &#x27;&quot;</span> &lt;&lt;</span><br><span class="line">                                  <span class="keyword">this</span>-&gt;<span class="built_in">getHardwareInterfaceType</span>() &lt;&lt; <span class="string">&quot;&#x27;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>(joints_.<span class="built_in">size</span>() == angle_wraparound_.<span class="built_in">size</span>());</span><br><span class="line">  <span class="built_in">ROS_DEBUG_STREAM_NAMED</span>(name_, <span class="string">&quot;Initialized controller &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class="string">&quot;&#x27; with:&quot;</span> &lt;&lt;</span><br><span class="line">                         <span class="string">&quot;\n- Number of joints: &quot;</span> &lt;&lt; <span class="built_in">getNumberOfJoints</span>() &lt;&lt;</span><br><span class="line">                         <span class="string">&quot;\n- Hardware interface type: &#x27;&quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;<span class="built_in">getHardwareInterfaceType</span>() &lt;&lt; <span class="string">&quot;&#x27;&quot;</span> &lt;&lt;</span><br><span class="line">                         <span class="string">&quot;\n- Trajectory segment type: &#x27;&quot;</span> &lt;&lt; hardware_interface::internal::<span class="built_in">demangledTypeName</span>&lt;SegmentImpl&gt;() &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Default tolerances</span></span><br><span class="line">  <span class="function">ros::NodeHandle <span class="title">tol_nh</span><span class="params">(controller_nh_, <span class="string">&quot;constraints&quot;</span>)</span></span>;</span><br><span class="line">  default_tolerances_ = <span class="built_in">getSegmentTolerances</span>&lt;Scalar&gt;(tol_nh, joint_names_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Hardware interface adapter</span></span><br><span class="line">  hw_iface_adapter_.<span class="built_in">init</span>(joints_, controller_nh_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ROS API: Subscribed topics</span></span><br><span class="line">  trajectory_command_sub_ = controller_nh_.<span class="built_in">subscribe</span>(<span class="string">&quot;command&quot;</span>, <span class="number">1</span>, &amp;JointTrajectoryController::trajectoryCommandCB, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ROS API: Published topics</span></span><br><span class="line">  state_publisher_.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">StatePublisher</span>(controller_nh_, <span class="string">&quot;state&quot;</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ROS API: Action interface</span></span><br><span class="line">  action_server_.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">ActionServer</span>(controller_nh_, <span class="string">&quot;follow_joint_trajectory&quot;</span>,</span><br><span class="line">                                        boost::<span class="built_in">bind</span>(&amp;JointTrajectoryController::goalCB,   <span class="keyword">this</span>, _1),</span><br><span class="line">                                        boost::<span class="built_in">bind</span>(&amp;JointTrajectoryController::cancelCB, <span class="keyword">this</span>, _1),</span><br><span class="line">                                        <span class="literal">false</span>));</span><br><span class="line">  action_server_-&gt;<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ROS API: Provided services</span></span><br><span class="line">  query_state_service_ = controller_nh_.<span class="built_in">advertiseService</span>(<span class="string">&quot;query_state&quot;</span>,</span><br><span class="line">                                                         &amp;JointTrajectoryController::queryStateService,</span><br><span class="line">                                                         <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Preeallocate resources</span></span><br><span class="line">  current_state_       = <span class="keyword">typename</span> Segment::<span class="built_in">State</span>(n_joints);</span><br><span class="line">  old_desired_state_   = <span class="keyword">typename</span> Segment::<span class="built_in">State</span>(n_joints);</span><br><span class="line">  desired_state_       = <span class="keyword">typename</span> Segment::<span class="built_in">State</span>(n_joints);</span><br><span class="line">  state_error_         = <span class="keyword">typename</span> Segment::<span class="built_in">State</span>(n_joints);</span><br><span class="line">  desired_joint_state_ = <span class="keyword">typename</span> Segment::<span class="built_in">State</span>(<span class="number">1</span>);</span><br><span class="line">  state_joint_error_   = <span class="keyword">typename</span> Segment::<span class="built_in">State</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  successful_joint_traj_ = boost::dynamic_bitset&lt;&gt;(<span class="built_in">getNumberOfJoints</span>());</span><br><span class="line"></span><br><span class="line">  hold_trajectory_ptr_ = <span class="built_in">createHoldTrajectory</span>(n_joints);</span><br><span class="line">  <span class="built_in">assert</span>(joint_names_.<span class="built_in">size</span>() == hold_trajectory_ptr_-&gt;<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stop_trajectory_duration_ == <span class="number">0.0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    hold_traj_builder_ = std::unique_ptr&lt;TrajectoryBuilder&lt;SegmentImpl&gt; &gt;(<span class="keyword">new</span> <span class="built_in">HoldTrajectoryBuilder</span>&lt;SegmentImpl, HardwareInterface&gt;(joints_));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    hold_traj_builder_ = std::unique_ptr&lt;TrajectoryBuilder&lt;SegmentImpl&gt; &gt;(<span class="keyword">new</span> <span class="built_in">StopTrajectoryBuilder</span>&lt;SegmentImpl&gt;(stop_trajectory_duration_, desired_state_));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    state_publisher_-&gt;<span class="built_in">lock</span>();</span><br><span class="line">    state_publisher_-&gt;msg_.joint_names = joint_names_;</span><br><span class="line">    state_publisher_-&gt;msg_.desired.positions.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;msg_.desired.velocities.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;msg_.desired.accelerations.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;msg_.actual.positions.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;msg_.actual.velocities.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;msg_.error.positions.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;msg_.error.velocities.<span class="built_in">resize</span>(n_joints);</span><br><span class="line">    state_publisher_-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <strong>&#x2F;<node_name>&#x2F;joints</strong> 参数获取节点列表。返回 std::vector<a href="std::string">std::string</a> 类型的节点列表。若节点列表为空，则直接退出</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">SegmentImpl</span>, <span class="keyword">class</span> <span class="title class_">HardwareInterface</span>&gt;</span><br><span class="line"><span class="type">void</span> JointTrajectoryController&lt;SegmentImpl, HardwareInterface&gt;::</span><br><span class="line"><span class="built_in">goalCB</span>(GoalHandle gh)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">ROS_DEBUG_STREAM_NAMED</span>(name_,<span class="string">&quot;Received new action goal&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Precondition: Running controller</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;<span class="built_in">isRunning</span>()) <span class="comment">// controller 未启动</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_ERROR_NAMED</span>(name_, <span class="string">&quot;Can&#x27;t accept new action goals. Controller is not running.&quot;</span>);</span><br><span class="line">    control_msgs::FollowJointTrajectoryResult result;</span><br><span class="line">    result.error_code = control_msgs::FollowJointTrajectoryResult::INVALID_GOAL; <span class="comment">// <span class="doctag">TODO:</span> Add better error status to msg?</span></span><br><span class="line">    gh.<span class="built_in">setRejected</span>(result);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If partial joints goals are not allowed, goal should specify all controller joints</span></span><br><span class="line">  <span class="keyword">if</span> (!allow_partial_joints_goal_)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// goal 中关节数与实际关节数不匹配</span></span><br><span class="line">    <span class="keyword">if</span> (gh.<span class="built_in">getGoal</span>()-&gt;trajectory.joint_names.<span class="built_in">size</span>() != joint_names_.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">ROS_ERROR_NAMED</span>(name_, <span class="string">&quot;Joints on incoming goal don&#x27;t match the controller joints.&quot;</span>);</span><br><span class="line">      control_msgs::FollowJointTrajectoryResult result;</span><br><span class="line">      result.error_code = control_msgs::FollowJointTrajectoryResult::INVALID_JOINTS;</span><br><span class="line">      gh.<span class="built_in">setRejected</span>(result);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Goal should specify valid controller joints (they can be ordered differently). Reject if this is not the case</span></span><br><span class="line">  <span class="keyword">using</span> internal::mapping;</span><br><span class="line">  std::vector&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt; mapping_vector = <span class="built_in">mapping</span>(gh.<span class="built_in">getGoal</span>()-&gt;trajectory.joint_names, joint_names_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mapping_vector.<span class="built_in">empty</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_ERROR_NAMED</span>(name_, <span class="string">&quot;Joints on incoming goal don&#x27;t match the controller joints.&quot;</span>);</span><br><span class="line">    control_msgs::FollowJointTrajectoryResult result;</span><br><span class="line">    result.error_code = control_msgs::FollowJointTrajectoryResult::INVALID_JOINTS;</span><br><span class="line">    gh.<span class="built_in">setRejected</span>(result);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to update new trajectory</span></span><br><span class="line">  <span class="function">RealtimeGoalHandlePtr <span class="title">rt_goal</span><span class="params">(<span class="keyword">new</span> RealtimeGoalHandle(gh))</span></span>;</span><br><span class="line">  std::string error_string;</span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> update_ok = <span class="built_in">updateTrajectoryCommand</span>(internal::<span class="built_in">share_member</span>(gh.<span class="built_in">getGoal</span>(), gh.<span class="built_in">getGoal</span>()-&gt;trajectory),</span><br><span class="line">                                                 rt_goal,</span><br><span class="line">                                                 &amp;error_string);</span><br><span class="line">  rt_goal-&gt;preallocated_feedback_-&gt;joint_names = joint_names_;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (update_ok)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Accept new goal</span></span><br><span class="line">    <span class="built_in">preemptActiveGoal</span>();</span><br><span class="line">    gh.<span class="built_in">setAccepted</span>();</span><br><span class="line">    rt_active_goal_ = rt_goal;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup goal status checking timer</span></span><br><span class="line">    goal_handle_timer_ = controller_nh_.<span class="built_in">createTimer</span>(action_monitor_period_,</span><br><span class="line">                                                    &amp;RealtimeGoalHandle::runNonRealtime,</span><br><span class="line">                                                    rt_goal);</span><br><span class="line">    goal_handle_timer_.<span class="built_in">start</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Reject invalid goal</span></span><br><span class="line">    control_msgs::FollowJointTrajectoryResult result;</span><br><span class="line">    result.error_code = control_msgs::FollowJointTrajectoryResult::INVALID_GOAL;</span><br><span class="line">    result.error_string = error_string;</span><br><span class="line">    gh.<span class="built_in">setRejected</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/16/Robot/ROS/ros_control/%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/16/Robot/ROS/ros_control/%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">示例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-16 08:02:12" itemprop="dateCreated datePublished" datetime="2024-10-16T08:02:12+08:00">2024-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-19 09:36:49" itemprop="dateModified" datetime="2024-10-19T09:36:49+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/" itemprop="url" rel="index"><span itemprop="name">Robot</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/" itemprop="url" rel="index"><span itemprop="name">ROS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/ros-control/" itemprop="url" rel="index"><span itemprop="name">ros_control</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Barrett"><a href="#Barrett" class="headerlink" title="Barrett"></a><strong>Barrett</strong></h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BarrettHW</span> : <span class="keyword">public</span> hardware_interface::RobotHW</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">   <span class="built_in">BarrettHW</span>(ros::NodeHandle nh);</span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">configure</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">const</span> ros::Time time, <span class="type">const</span> ros::Duration period)</span></span>; </span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> ros::Time time, <span class="type">const</span> ros::Duration period)</span></span>;</span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123; &#125; </span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">private</span>:   </span><br><span class="line">  <span class="comment">// ros-controls interface</span></span><br><span class="line">   hardware_interface::JointStateInterface state_interface_;</span><br><span class="line">   hardware_interface::EffortJointInterface effort_interface_;</span><br><span class="line">   barrett_model::SemiAbsoluteJointInterface semi_absolute_interface_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wam_server.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">BarrettHW::configure</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(barrett_manager-&gt;<span class="built_in">foundWam4</span>()) &#123; </span><br><span class="line">        wam4s_[product_name] = <span class="keyword">this</span>-&gt;<span class="built_in">configure_wam</span>&lt;<span class="number">4</span>&gt;(product_nh, barrett_manager, wam_config);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(barrett_manager-&gt;<span class="built_in">foundWam7</span>()) &#123;</span><br><span class="line">        wam7s_[product_name] = <span class="keyword">this</span>-&gt;<span class="built_in">configure_wam</span>&lt;<span class="number">7</span>&gt;(product_nh, barrett_manager, wam_config);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">ROS_ERROR</span>(<span class="string">&quot;Could not find WAM on bus!&quot;</span>); </span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="type">size_t</span> DOF&gt;</span><br><span class="line">    boost::shared_ptr&lt;BarrettHW::WamDevice&lt;DOF&gt; &gt; </span><br><span class="line">    BarrettHW::<span class="built_in">configure_wam</span>(</span><br><span class="line">        ros::NodeHandle product_nh,</span><br><span class="line">        boost::shared_ptr&lt;barrett::ProductManager&gt; barrett_manager, </span><br><span class="line">        <span class="type">const</span> libconfig::Setting &amp;wam_config) </span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Store the joint name</span></span><br><span class="line">        wam_device-&gt;joint_names[i] = joint-&gt;name;</span><br><span class="line">        wam_device-&gt;<span class="built_in">effort_limits</span>(i) = joint-&gt;limits-&gt;effort;</span><br><span class="line">        wam_device-&gt;<span class="built_in">velocity_limits</span>(i) = joint-&gt;limits-&gt;velocity;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Joint State Handle</span></span><br><span class="line">        <span class="function">hardware_interface::JointStateHandle <span class="title">state_handle</span><span class="params">(joint-&gt;name,</span></span></span><br><span class="line"><span class="params"><span class="function">            &amp;wam_device-&gt;joint_positions(i),</span></span></span><br><span class="line"><span class="params"><span class="function">            &amp;wam_device-&gt;joint_velocities(i),</span></span></span><br><span class="line"><span class="params"><span class="function">            &amp;wam_device-&gt;joint_effort_cmds(i))</span></span>;</span><br><span class="line">        state_interface_.<span class="built_in">registerHandle</span>(state_handle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Effort Command Handle</span></span><br><span class="line">        effort_interface_.<span class="built_in">registerHandle</span>(</span><br><span class="line">            hardware_interface::<span class="built_in">JointHandle</span>(</span><br><span class="line">              state_interface_.<span class="built_in">getHandle</span>(joint-&gt;name),</span><br><span class="line">              &amp;wam_device-&gt;<span class="built_in">joint_effort_cmds</span>(i)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Transmission / Calibration handle</span></span><br><span class="line">        semi_absolute_interface_.<span class="built_in">registerJoint</span>(</span><br><span class="line">            effort_interface_.<span class="built_in">getHandle</span>(joint-&gt;name),</span><br><span class="line">            wam_device-&gt;<span class="built_in">resolver_ranges</span>(i),</span><br><span class="line">            &amp;wam_device-&gt;<span class="built_in">resolver_angles</span>(i),</span><br><span class="line">            &amp;wam_device-&gt;<span class="built_in">joint_offsets</span>(i),</span><br><span class="line">            &amp;wam_device-&gt;<span class="built_in">calibrated_joints</span>(i));</span><br><span class="line">    ...</span><br><span class="line">&#125;            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">BarrettHW::read</span><span class="params">(<span class="type">const</span> ros::Time time, <span class="type">const</span> ros::Duration period)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Iterate over all devices</span></span><br><span class="line">    <span class="keyword">for</span>(Wam4Map::iterator it = wam4s_.<span class="built_in">begin</span>(); it != wam4s_.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">      <span class="comment">// 调用 barrett::LowLevelWam 接口读取设备数据  </span></span><br><span class="line">      <span class="keyword">this</span>-&gt;<span class="built_in">read_wam</span>(time, period, it-&gt;second);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(Wam7Map::iterator it = wam7s_.<span class="built_in">begin</span>(); it != wam7s_.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">      <span class="keyword">this</span>-&gt;<span class="built_in">read_wam</span>(time, period, it-&gt;second);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BarrettHW::write</span><span class="params">(<span class="type">const</span> ros::Time time, <span class="type">const</span> ros::Duration period)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Iterate over all devices</span></span><br><span class="line">    <span class="keyword">for</span>(Wam4Map::iterator it = wam4s_.<span class="built_in">begin</span>(); it != wam4s_.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">      <span class="keyword">this</span>-&gt;<span class="built_in">write_wam</span>(time, period, it-&gt;second);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(Wam7Map::iterator it = wam7s_.<span class="built_in">begin</span>(); it != wam7s_.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">      <span class="keyword">this</span>-&gt;<span class="built_in">write_wam</span>(time, period, it-&gt;second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">barrett_hw::BarrettHW <span class="title">barrett_robot</span><span class="params">(barrett_nh)</span></span>;</span><br><span class="line">    barrett_robot.<span class="built_in">configure</span>();</span><br><span class="line">    barrett_robot.<span class="built_in">start</span>();</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(!g_quit) &#123;</span><br><span class="line">        ...    </span><br><span class="line">        <span class="comment">// Read the state from the WAM</span></span><br><span class="line">        <span class="keyword">if</span>(!barrett_robot.<span class="built_in">read</span>(now, period)) &#123;</span><br><span class="line">          g_quit=<span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Update the controllers</span></span><br><span class="line">        manager.<span class="built_in">update</span>(now, period);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Write the command to the WAM</span></span><br><span class="line">        barrett_robot.<span class="built_in">write</span>(now, period);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;              </span><br></pre></td></tr></table></figure>



<p>测试 launch</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">launch&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;JOINT_PREFIX&quot;</span> <span class="attr">default</span>=<span class="string">&quot;wam&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- WAM Server --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;barrett_hw&quot;</span> <span class="attr">type</span>=<span class="string">&quot;wam_server&quot;</span> <span class="attr">name</span>=<span class="string">&quot;wam_server&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- WAM Parameters --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">ns</span>=<span class="string">&quot;wam&quot;</span> <span class="attr">file</span>=<span class="string">&quot;$(find barrett_model)/launch/wam_7dof_params.launch&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;wam/can_dev_name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;rtcan0&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Controllers --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rosparam</span> <span class="attr">ns</span>=<span class="string">&quot;wam&quot;</span>&gt;</span></span><br><span class="line">    joint_state_controller:</span><br><span class="line">      type: joint_state_controller/JointStateController</span><br><span class="line">      publish_rate: 50</span><br><span class="line">    calibration_controller:</span><br><span class="line">      type: barrett_controllers/CalibrationController</span><br><span class="line">      publish_rate: 50</span><br><span class="line">      joint_names:             [&#x27;wam/YawJoint&#x27;,&#x27;wam/ShoulderPitchJoint&#x27;,&#x27;wam/ShoulderYawJoint&#x27;,&#x27;wam/ElbowJoint&#x27;,&#x27;wam/UpperWristYawJoint&#x27;,&#x27;wam/UpperWristPitchJoint&#x27;,&#x27;wam/LowerWristYawJoint&#x27;]</span><br><span class="line">      static_thresholds:       [0.001, 0.001, 0.001, 0.0005, 0.001, 0.001, 0.0005]</span><br><span class="line">      upper_limits:            [ 2.7,  2.0,  2.9, 3.16,  1.34,  1.5708,  2.970]</span><br><span class="line">      lower_limits:            [-2.7, -2.0, -2.9, -0.9, -4.76, -1.5708, -2.970]</span><br><span class="line">      limit_search_directions: [1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0]</span><br><span class="line">      home_positions:          [0.0, -1.5708, 0.0, 0.0, -1.5708, 0.0, 0.0]</span><br><span class="line">      resolver_offsets:        [-0.0224, 0.0179, -0.1656, -0.28954, 0.2419, -0.09215, -0.054]</span><br><span class="line">      home_positions_:          [0.0, -1.5708, 0.0, 0.0, -1.5708, 0.0, 0.0]</span><br><span class="line">      resolver_offsets_:        [0.0, 0.053, -0.170, -0.289, 0.240, -0.094, -0.054]</span><br><span class="line">      p_gains:                 [280.0, 250.0, 100.0, 60.0, 20.0, 30.0, 2.0]</span><br><span class="line">      i_gains:                 [100.0, 70.0, 70.0, 70.0, 10.0, 10.0, 10.0]</span><br><span class="line">      i_max:                   [20.0, 20.0, 20.0, 20.0, 1.0, 1.0, 0.2]</span><br><span class="line">      d_gains:                 [20.0, 20.0, 2.0, 2.0, 0.5, 0.5, 0.05]</span><br><span class="line">      trap_max_vels:           [0.2, 0.4, 1.5, 0.8, 4.0, 4.0, 8.0]</span><br><span class="line">      trap_max_accs:           [0.2, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8]</span><br><span class="line">      trap_durations:          [15.0, 15.0, 15.0, 15.0, 5.0, 5.0, 5.0]</span><br><span class="line">    effort_controller:</span><br><span class="line">      type: effort_controllers/JointEffortController</span><br><span class="line">      joint: wam/ElbowJoint </span><br><span class="line">  <span class="tag">&lt;/<span class="name">rosparam</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Start these controllers by default --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;default_controller_spawner&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">pkg</span>=<span class="string">&quot;controller_manager&quot;</span> <span class="attr">type</span>=<span class="string">&quot;spawner&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">args</span>=<span class="string">&quot;wam/joint_state_controller wam/calibration_controller&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​             </p>
<p>其中，calibration_controller 继承 controller_interface::Controller</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 操作 joints 的硬件接口(Hardware interface)</span></span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">SemiAbsoluteJointInterface</span> : </span><br><span class="line">         <span class="keyword">public</span> hardware_interface::HardwareInterface </span><br><span class="line"> &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">CalibrationController</span> : <span class="keyword">public</span> controller_interface::Controller&lt;barrett_model::SemiAbsoluteJointInterface&gt;</span><br><span class="line"> &#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<h1 id="Husky"><a href="#Husky" class="headerlink" title="Husky"></a><strong>Husky</strong></h1><p>HuskyHardware 继承 hardware_interface::RobotHW</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HuskyHardware</span> : <span class="keyword">public</span> hardware_interface::RobotHW </span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 从 MCU 获取最新的速度和行程测量值，并存储在 ros_control 的 joint structure 中</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">updateJointsFromHardware</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 通过 joint structure 从 ros_control 获取最新的速度指令，并发送到 MCU</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeCommandsToHardware</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​       </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/16/Robot/ROS/ros_control/controller_manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/16/Robot/ROS/ros_control/controller_manager/" class="post-title-link" itemprop="url">controller_manager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-16 07:48:31" itemprop="dateCreated datePublished" datetime="2024-10-16T07:48:31+08:00">2024-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-19 09:37:02" itemprop="dateModified" datetime="2024-10-19T09:37:02+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/" itemprop="url" rel="index"><span itemprop="name">Robot</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/" itemprop="url" rel="index"><span itemprop="name">ROS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Robot/ROS/ros-control/" itemprop="url" rel="index"><span itemprop="name">ros_control</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>controller_manager 提供了一个硬实时兼容的循环来控制机械臂的机制，该循环由 <code>hardware_interface::RobotHW</code>  实例表示。controller_manager 提供了用于加载，卸载，启动和停止控制器的基础结构。</p>
<p>当加载一个控制器时，controller_manager 会使用控制器名作为所有特定于控制器的参数的根，最重要的是，type 用来标识加载哪个插件。</p>
<p>controller manager 提供了与 controller 交互的工具。根据是从启动文件、从命令行还是从 ROS 节点运行 controller，controller manager 提供了不同的工具来运行 controller。</p>
<h1 id="命令行工具"><a href="#命令行工具" class="headerlink" title="命令行工具"></a>命令行工具</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">支持的 <span class="built_in">command</span> 包括：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	load：加载 controllers(构造和初始化)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	unload：卸载 controllers(析构)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	start：启动 controllers</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	stop：停止 controllers</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	spawn：加载并启动 controllers</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	<span class="built_in">kill</span>：停止并卸载 controllers</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun controller_manager controller_manager &lt;<span class="built_in">command</span>&gt; &lt;name1&gt; &lt;name2&gt; ...</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取 controllers 状态</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">支持以下 <span class="built_in">command</span>：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	list：按执行顺序列出所有 controllers，并给出每个 controller 的状态</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	list-type：列出 controller 类型，如果 controller 不在该列表中，将无法执行 spawn</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	reload-libraries：重新加载所有可用的控制器库插件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">	reload-libraries --restore：重新加载所有可用作为插件的控制器库，并将所有控制器恢复到其原始状态</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun controller_manager controller_manager &lt;<span class="built_in">command</span>&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--stop：不自动启动</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&lt;name&gt;: 指定要加载的 controller 列表，空格分割（也可指定 yaml 文件路径）</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun controller_manager spawner [--stopped] &lt;name1&gt; &lt;name2&gt; ...</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun controller_manager unspawner &lt;name1&gt; &lt;name2&gt; ... <span class="comment"># 停止但不卸载，这些controllers 关闭时重启</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>spawner 节点通过调用 <code>controller_manager/load_controller</code> 服务来加载参数中指定的 controllers。</strong> </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun rqt_controller_manager rqt_controller_manager</span></span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- launch 文件中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;arm_controller_spawner&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;controller_manager&quot;</span> <span class="attr">type</span>=<span class="string">&quot;spawner&quot;</span> <span class="attr">respawn</span>=<span class="string">&quot;false&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span> <span class="attr">ns</span>=<span class="string">&quot;/arm&quot;</span> <span class="attr">args</span>=<span class="string">&quot;arm_joint_controller gripper_controller&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>





<p>ROS API</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">controller_manager/load_controller</span><br><span class="line">controller_manager/unload_controller</span><br><span class="line">controller_manager/switch_controller</span><br><span class="line">controller_manager/list_controllers</span><br><span class="line">controller_manager/list_controller_types</span><br><span class="line">controller_manager/reload_controller_libraries</span><br></pre></td></tr></table></figure>



<h1 id="controller-group"><a href="#controller-group" class="headerlink" title="controller_group"></a>controller_group</h1><p>melodic 版本才支持。controller_manager 允许开发者在运行时切换 controllers，但是当出于某些特殊目的想要从一组 controllers 切换到另一组 controllers 时，这样做并不方便。如果在 ROS 参数controller_groups 中定义了此类组，则 controller_group 脚本将使此操作变得容易。它知道所涉及的所有 controllers，然后知道从一组切换到另一组时需要停止和启动的 controllers。因此，不同的组可以共享一些 controllers。</p>
<p>controller_groups 参数示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">controller_groups:</span></span><br><span class="line">  <span class="attr">production:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prod_controller_1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prod_controller_2</span></span><br><span class="line">  <span class="attr">development:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">devel_controller_1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">devel_controller_2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">shared_controller_3</span></span><br><span class="line">  <span class="attr">diagnostics:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">diag_controller_1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">diag_controller_2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">shared_controller_3</span></span><br></pre></td></tr></table></figure>

<p>运行 controller_group 脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">可用 commands 包括：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> - list：列出 controllers_groups 参数定义的所有 group</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> - spwan ：加载并启动 group 中的所有 controllers，通常用于 ros launch 文件中</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> - switch ：切换到 group 组。表示停止不在该 group 中的正在运行的 controllers，并启动 group 中定义的尚未启动的 controllers</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun controller_manager controller_group &lt;<span class="built_in">command</span>&gt; &lt;args&gt;</span>     </span><br></pre></td></tr></table></figure>

<h1 id="加载-controllers"><a href="#加载-controllers" class="headerlink" title="加载 controllers"></a>加载 controllers</h1><h2 id="URDF-中加载"><a href="#URDF-中加载" class="headerlink" title="URDF 中加载"></a>URDF 中加载</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gazebo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">name</span>=<span class="string">&quot;diff_drive_controller&quot;</span> <span class="attr">filename</span>=<span class="string">&quot;libgazebo_ros_diff_drive.so&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">legacyMode</span>&gt;</span>false<span class="tag">&lt;/<span class="name">legacyMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alwaysOn</span>&gt;</span>true<span class="tag">&lt;/<span class="name">alwaysOn</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updateRate</span>&gt;</span>1000.0<span class="tag">&lt;/<span class="name">updateRate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">leftJoint</span>&gt;</span>wheel_left_joint<span class="tag">&lt;/<span class="name">leftJoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rightJoint</span>&gt;</span>wheel_right_joint<span class="tag">&lt;/<span class="name">rightJoint</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="使用-spawner-加载"><a href="#使用-spawner-加载" class="headerlink" title="使用 spawner 加载"></a>使用 spawner 加载</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rosparam</span> <span class="attr">file</span>=<span class="string">&quot;$(find test_gazebo)/config/controller.yaml&quot;</span> <span class="attr">command</span>=<span class="string">&quot;load&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;controller_spawner&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;controller_manager&quot;</span> <span class="attr">type</span>=<span class="string">&quot;spawner&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">respawn</span>=<span class="string">&quot;false&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span> <span class="attr">args</span>=<span class="string">&quot;mobile_base_controller&quot;</span> /&gt;</span></span><br><span class="line">&lt;-- 其中, controller.yaml 文件内容为</span><br><span class="line">mobile_base_controller:</span><br><span class="line">  type: &quot;diff_drive_controller/DiffDriveController&quot;</span><br><span class="line">  left_wheel: &#x27;wheel_left_joint&#x27;</span><br><span class="line">  right_wheel: &#x27;wheel_right_joint&#x27;</span><br><span class="line">  pose_covariance_diagonal: [0.001, 0.001, 1000000.0, 1000000.0, 1000000.0, 1000.0]</span><br><span class="line">  twist_covariance_diagonal: [0.001, 0.001, 1000000.0, 1000000.0, 1000000.0, 1000.0]</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者使用命令行指令</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rosrun controller_manager spawner [--stopped] &lt;name1&gt; &lt;name2&gt; ...</span></span><br></pre></td></tr></table></figure>



<h2 id="通过-controller-manager-节点动态加载"><a href="#通过-controller-manager-节点动态加载" class="headerlink" title="通过 controller_manager 节点动态加载"></a>通过 controller_manager 节点动态加载</h2><h2 id="通过-controller-group-加载"><a href="#通过-controller-group-加载" class="headerlink" title="通过 controller group 加载"></a>通过 controller group 加载</h2><h1 id="launch-文件"><a href="#launch-文件" class="headerlink" title="launch 文件"></a>launch 文件</h1><p>可在 launch 文件中使用 <strong>controller_manager</strong> 来启动 controllers。但即使在 launch 文件被停止后，controllers 仍然会保持运行。而使用 <strong>spawner</strong> 工具从 launch 文件中自动加载、启动、停止和卸载 controllers，当启动 spawner 时，将加载并启动 controllers，当停止 spawner 时(如：launch 文件被停止时)，将停止并卸载 controllers。launch 文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;controller_manager&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">type</span>=<span class="string">&quot;spawner&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">args</span>=<span class="string">&quot;controller_name1 controller_name2&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者只加载 controller，不启动它(<strong>–stopped</strong>)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;controller_manager&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">type</span>=<span class="string">&quot;spawner&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">args</span>=<span class="string">&quot;--stopped controller_name1 controller_name2&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/28/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-I/%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/28/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-I/%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/" class="post-title-link" itemprop="url">接口规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-28 12:27:43 / 修改时间：13:34:12" itemprop="dateCreated datePublished" datetime="2024-09-28T12:27:43+08:00">2024-09-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%BA%E6%A2%B0%E8%87%82/" itemprop="url" rel="index"><span itemprop="name">机械臂</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-Industrial/" itemprop="url" rel="index"><span itemprop="name">ROS-Industrial</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>提供一些关于 ROS 工业机器人应提供哪些特定 ROS 接口的指南，以确保最大的兼容性。</p>
<h1 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h1><p>参考：<a target="_blank" rel="noopener" href="https://github.com/ros-industrial/rep/blob/master/rep-I0006.rst">https://github.com/ros-industrial/rep/blob/master/rep-I0006.rst</a></p>
<h1 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h1><p>关于初始化：</p>
<ul>
<li><p>ROS node 需自动初始化与机器人控制器的所有连接</p>
<ul>
<li>不应该出现需手动连接的需求</li>
</ul>
</li>
<li><p>机械臂端代码最好在控制器启动时自动运行</p>
</li>
</ul>
<p>关于通信：</p>
<ul>
<li>机械臂和 ROS 节点都需要处理通信断连情况<ul>
<li>ROS 节点端：<ul>
<li>以固定频率（如 1Hz）重连</li>
<li>断连后停止发送大部分消息</li>
<li>继续发送 state 消息，其中 <code>connected=false</code></li>
</ul>
</li>
<li>机械臂端：<ul>
<li>停止运动，并将驱动断电</li>
<li>重新初始化所有连接，等待新的连接请求</li>
</ul>
</li>
<li>如果接口不能直接检测到通信中断，则需要在机器人&#x2F;ROS双方之间实现心跳消息</li>
</ul>
</li>
</ul>
<h1 id="ROS-API"><a href="#ROS-API" class="headerlink" title="ROS API"></a>ROS API</h1><p>定义机器人应该提供的 ROS 接口。</p>
<h2 id="通用参数"><a href="#通用参数" class="headerlink" title="通用参数"></a>通用参数</h2><ul>
<li><code>robot_ip_address</code></li>
<li><code>robot_description</code>：URDF</li>
</ul>
<h2 id="State-Feedback"><a href="#State-Feedback" class="headerlink" title="State Feedback"></a>State Feedback</h2><p>通过 Topics 发布状态信息</p>
<ul>
<li><code>feedback_states</code><ul>
<li>ROS-I <a target="_blank" rel="noopener" href="https://github.com/ros-industrial/industrial_core/blob/groovy-devel/industrial_robot_client/src/joint_trajectory_action.cpp">joint_trajectory_action</a> 订阅该主题数据来监测正在执行的运动</li>
</ul>
</li>
<li><code>joint_state</code>：关节位姿信息（及 速度&#x2F;力）</li>
<li><code>robot_status</code>：<a target="_blank" rel="noopener" href="https://docs.ros.org/en/groovy/api/industrial_msgs/html/msg/RobotStatus.html">industrial_msgs&#x2F;RobotStatus</a> 类型</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">std_msgs/Header header</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UNKNOWN: -1</span></span><br><span class="line"><span class="comment"> * MANUAL: 1 # 手动控制</span></span><br><span class="line"><span class="comment"> * AUTO: 2</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line">industrial_msgs/RobotMode mode</span><br><span class="line">industrial_msgs/TriState e_stopped</span><br><span class="line">industrial_msgs/TriState drives_powered</span><br><span class="line">industrial_msgs/TriState motion_possible</span><br><span class="line">industrial_msgs/TriState in_motion</span><br><span class="line">industrial_msgs/TriState in_error</span><br><span class="line">int32 error_code</span><br></pre></td></tr></table></figure>





<h2 id="运动控制"><a href="#运动控制" class="headerlink" title="运动控制"></a>运动控制</h2><h3 id="订阅主题"><a href="#订阅主题" class="headerlink" title="订阅主题"></a>订阅主题</h3><ul>
<li><p><code>joint_path_command</code> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// trajectory_msgs/JointTrajectory 类型</span></span><br><span class="line"></span><br><span class="line">std_msgs/Header header</span><br><span class="line"><span class="comment">// 关节列表</span></span><br><span class="line">string[] joint_names </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 轨迹点链表。每个轨迹点包含：</span></span><br><span class="line"><span class="comment"> * 	float64[] positions # 该轨迹点时各关节的位姿</span></span><br><span class="line"><span class="comment"> * 	float64[] velocities # 该轨迹点上各关节的速度</span></span><br><span class="line"><span class="comment"> * 	float64[] accelerations # 该轨迹点上各关节的加速度</span></span><br><span class="line"><span class="comment"> *	float64[] effort # 该轨迹点上各关节的力</span></span><br><span class="line"><span class="comment"> *  duration time_from_start # 该轨迹点与轨迹起点间隔（即：多久运行到该轨迹点）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  time_from_stat 可替代速度参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">trajectory_msgs/JointTrajectoryPoint[] points</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>joint_command</code> ：消息类型为 <a target="_blank" rel="noopener" href="http://docs.ros.org/en/api/trajectory_msgs/html/msg/JointTrajectoryPoint.html">trajectory_msgs&#x2F;JointTrajectoryPoint</a> 。流式下路径点</p>
</li>
</ul>
<h3 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h3><ul>
<li><p><code>stop_motion</code>：停止当前运动</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">industrial_msgs/ServiceReturnCode code</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>joint_path_command</code>：执行运动轨迹，与 <code>joint_path_command</code> 主题功能相同</p>
</li>
</ul>
<h3 id="Kinematics"><a href="#Kinematics" class="headerlink" title="Kinematics"></a>Kinematics</h3><p>为了实现实时运动规划和避撞，节点应该提供机器人特定的逆运动学求解器。ROS 提供了一个通用求解器，但它的运行速度太慢，无法进行避障路径规划。</p>
<p>这类求解器应该作为插件而不是服务与 ROS 集成，以避免昂贵的通信相关开销（可使用共享内存解决通信开销问题）。</p>
<h3 id="路径精度"><a href="#路径精度" class="headerlink" title="路径精度"></a>路径精度</h3><p>上面提到的运动接口没有指定遵循特定轨迹所需的精度。实现的路径精度水平将取决于特定机器人、控制器和 ROS 接口驱动程序的限制。</p>
<p>ROS 路径规划器和碰撞检查器使用<strong>高阶平滑</strong>路径点之间的轨迹。由机器人控制器执行的最终轨迹将遵循类似的“平滑”轨迹，“但可能与“理想的”计划轨迹不完全匹配”。出于这个原因，ROS 路径规划器在机器人模型中添加了一定数量的 padding，以考虑规划路径与实际路径之间的差异。这将导致无碰撞运动的概率非常高。增加 padding 的级别可以减少碰撞的概率。</p>
<p>路径规划器和机器人控制器之间的紧密集成将减少路径执行误差和碰撞填充要求。然而，这种集成水平超出了当前 ROS-Industrial 努力的范围，可能需要机器人特定的解决方案。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/28/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-I/ROS-Industrial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/28/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-I/ROS-Industrial/" class="post-title-link" itemprop="url">ROS-Industrial</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-28 12:16:44 / 修改时间：12:31:20" itemprop="dateCreated datePublished" datetime="2024-09-28T12:16:44+08:00">2024-09-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%BA%E6%A2%B0%E8%87%82/" itemprop="url" rel="index"><span itemprop="name">机械臂</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-Industrial/" itemprop="url" rel="index"><span itemprop="name">ROS-Industrial</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>43</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <img src="/2024/09/28/%E6%9C%BA%E6%A2%B0%E8%87%82/ROS-I/ROS-Industrial/ros_industrial_architecture.png" class="" title="ROS-Industrial Architecture">



<p>将不同供应商的机器人的控制与通用 ROS 框架集成，实现不同供应商的机器人之间的互操作性。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/22/Docker/Docker-compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/22/Docker/Docker-compose/" class="post-title-link" itemprop="url">Docker-compose</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-22 17:12:50 / 修改时间：17:29:39" itemprop="dateCreated datePublished" datetime="2024-09-22T17:12:50+08:00">2024-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>compose、machine 和 swarm 是 docker 原生提供的三大编排工具。</p>
<h1 id="Compose"><a href="#Compose" class="headerlink" title="Compose"></a>Compose</h1><p>Compose 是一个使用 Docker 定义和运行复杂应用程序的工具。<strong>使用 Compose，可以在单个文件中定义一个多容器应用程序</strong>，然后在单个命令中启动应用程序，该命令会执行运行所需的所有操作。所以基本上，这将有助于缩短需要在 Docker CLI 中键入的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PIP 安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> pip install docker-compose</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -L https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-`<span class="built_in">uname</span> -s`-`<span class="built_in">uname</span> -m` &gt; /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">卸载</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">rm</span> /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure>



<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>Docker Compose 默认配置文件名为 <code>docker_compose.yaml</code>。也可以使用 <code>-f</code> 参数指定具体文件。</p>
<p>Docker Compose 的 YAML 包含 4 个一级 key：</p>
<ul>
<li><strong>version</strong>：必须指定，且总是位于文件第一行。指定 Compose 文件格式的版本（注意：不是 Compose 或 docker engine 的版本）。 Compose 文件格式有3个版本,分别为1, 2.x 和 3.x。目前主流的为 3.x 其支持 docker 1.13.0 及其以上的版本。参考：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/compose-versioning/">compose-version</a></li>
<li><strong>services</strong>：用于定义不同的应用服务。Docker Compose 会将每个服务部署在各自的容器中。services 下面的第一级别的 key 即为 service 的名称</li>
<li><strong>networks</strong>：定义网络信息。<strong>默认情况下，Docker Compose 会创建 bridge 网络。这是一种单主机网络，只能够实现同一主机上容器的连接</strong>。当然，也可以使用 driver 属性来指定不同的网络类型</li>
<li><strong>volumes</strong>：定义卷信息</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  <span class="comment"># 绝对路径</span></span><br><span class="line">  - <span class="string">&quot;/mydata/docker_mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">  <span class="comment"># 相对路径，相对当前 docker-compose.yml 文件所在目录</span></span><br><span class="line">  - “./conf:/etc/mysql/conf.d“</span><br><span class="line">  <span class="comment"># 匿名挂载，匿名挂载只需要写容器目录即可，容器外对应的目录会在 /var/lib/docker/volume 中生成</span></span><br><span class="line">  - <span class="string">&quot;/var/lib/mysql&quot;</span></span><br><span class="line">  <span class="comment"># 具名挂载，就是给数据卷起了个名字，容器外对应的目录会在 /var/lib/docker/volume 中生成</span></span><br><span class="line">  - <span class="string">&quot;mysql-data-volume:/var/lib/mysql&quot;</span></span><br></pre></td></tr></table></figure>



<p>其它 key：</p>
<ul>
<li><p><strong>build</strong>：配置构建时，Compose 会利用它自动构建镜像，该值可以是一个路径，也可以是一个对象，用于指定 Dockerfile 参数</p>
</li>
<li><ul>
<li>context：指定 Dockerfile 文件路径</li>
<li>dockerfile：指定 context 目录下的 Dockerfile 名称</li>
<li>args：该 Dockerfile 在 build 过程中需要的参数。(等同于 docker container build –build-arg)</li>
<li>cache_from：v3.2 新增参数。指定缓存镜像列表。 (等同于 docker container build –cache_from)</li>
<li>labels：v3.3 新增参数。设置镜像元数据。(等同于 docker container build –labels)</li>
<li>shm_size：v3.5 新增。设置容器 &#x2F;dev&#x2F;shm 分区大小(等同于 docker container build –shm-size)</li>
</ul>
</li>
<li><pre><code class="docker">build: ./dir
---------------
build:
    context: ./dir
    dockerfile: Dockerfile
    args:
        buildno: 1
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ​            </span><br><span class="line"></span><br><span class="line">- **command**：覆盖容器启动后默认执行的命令</span><br><span class="line"></span><br><span class="line">```docker</span><br><span class="line">command: bundle exec thin -p 3000</span><br><span class="line">----------------------------------</span><br><span class="line">command: [bundle,exec,thin,-p,3000]</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>​    </p>
<ul>
<li>entrypoint：覆盖容器的默认 entrypoint 指令(等同于 docker run –entrypoint)</li>
<li><strong>dns</strong>：配置 dns 服务器。可以是一个值或列表</li>
<li><strong>dns_search</strong>：配置 DNS 搜索域。可以是一个值或列表</li>
</ul>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dns: <span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line">------------</span><br><span class="line">dns:</span><br><span class="line">    - <span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line">    - <span class="number">9.9</span>.<span class="number">9.9</span></span><br><span class="line">    </span><br><span class="line">dns_search: example.com</span><br><span class="line">------------------------</span><br><span class="line">dns_search:</span><br><span class="line">    - dc1.example.com</span><br><span class="line">    - dc2.example.com    </span><br></pre></td></tr></table></figure>

<p>​              </p>
<ul>
<li><strong>environment</strong>：环境变量配置。可以用数组或字典两种方式</li>
<li><strong>env_file</strong>：从文件中获取环境变量，可以指定一个文件路径或路径列表，其<strong>优先级低于 environment</strong> 指定的环境变量</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">environment:</span><br><span class="line">    RACK_ENV: development</span><br><span class="line">    SHOW: <span class="string">&#x27;ture&#x27;</span></span><br><span class="line">-------------------------</span><br><span class="line">environment:</span><br><span class="line">    - RACK_ENV=development</span><br><span class="line">    - SHOW=ture</span><br><span class="line">    </span><br><span class="line">env_file: .<span class="keyword">env</span></span><br><span class="line">---------------</span><br><span class="line">env_file:</span><br><span class="line">    - ./common.<span class="keyword">env</span>    </span><br></pre></td></tr></table></figure>



<ul>
<li><strong>expose</strong>：暴露端口，只将端口暴露给连接的服务，而不暴露给主机</li>
<li><strong>image</strong>：指定服务所使用的镜像</li>
<li><strong>network_mode</strong>：设置网络模式</li>
</ul>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">network_mode: <span class="string">&quot;bridge&quot;</span></span><br><span class="line">network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">network_mode: <span class="string">&quot;none&quot;</span></span><br><span class="line">network_mode: <span class="string">&quot;service:[service name]&quot;</span></span><br><span class="line">network_mode: <span class="string">&quot;container:[container name/id]&quot;</span></span><br></pre></td></tr></table></figure>

<p>​         </p>
<ul>
<li><strong>ports</strong>：对外暴露的端口定义，和 expose 对应</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ports:   <span class="comment"># 暴露端口信息  - &quot;宿主机端口:容器暴露端口&quot;</span></span><br><span class="line">  - <span class="string">&quot;8763:8763&quot;</span></span><br><span class="line">  - <span class="string">&quot;8763:8763&quot;</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p><strong>links</strong>：将指定容器连接到当前连接，可以设置别名，避免ip方式导致的容器重启动态改变的无法连接情况</p>
</li>
<li><p><strong>logs</strong>：日志输出信息</p>
</li>
<li><p><strong>deploy</strong>：v3.x 版本，指定与部署和运行服务相关的配置。deploy 部分是 docker stack 使用的, docker stack 依赖 docker swarm</p>
</li>
<li><ul>
<li><p>endpoint_mode：v3.3 新增，指定服务暴露方式</p>
</li>
<li><ul>
<li><p>vip：Docker 为该服务分配一个虚拟 IP(VIP)，作为客户端的访问服务的地址</p>
</li>
<li><p>dnsrr：DNS 轮询，Docker 为该服务设置 DNS 条目，使得服务名称的 DNS 查询返回一个 IP 地址列表，客户端直接访问其中的一个地址</p>
</li>
<li><p>labels：指定服务的标签</p>
</li>
<li><p>mode：指定 delopy 的模式</p>
</li>
<li><ul>
<li>global：每个集群节点都只有一个容器</li>
<li>replicated：用户可指定集群中容器的数量</li>
</ul>
</li>
<li><p>placement：</p>
</li>
<li><p>replicate：mode 为 replicated 时，指定容器副本数量</p>
</li>
<li><p>resources：资源限制</p>
</li>
<li><ul>
<li><p>limits：设置容器资源限制</p>
</li>
<li><ul>
<li>cpus：”0.5” 表示最多只能使用 50% CPU</li>
<li>memory：50M 表示最多智能使用 50M 内存空间</li>
</ul>
</li>
<li><p>reservations：设置为容器预留的系统资源</p>
</li>
<li><ul>
<li>cpus：”0.2” 保留 20% 的 CPU</li>
<li>memory：20M 保留 20M 内存</li>
</ul>
</li>
</ul>
</li>
<li><p>restart_policy：定义容器重启策略, <strong>用于代替 restart 参数</strong></p>
</li>
<li><ul>
<li><p>condition：定义容器重启策略(接受三个参数)</p>
</li>
<li><ul>
<li>none：不尝试重启</li>
<li>on-failure：只有当容器内部应用程序出现问题才会重启</li>
<li>any：无论如何都会尝试重启(默认)</li>
</ul>
</li>
<li><p>delay：尝试重启的间隔时间(默认为 0s)</p>
</li>
<li><p>max_attempts：尝试重启次数(默认一直尝试重启)</p>
</li>
<li><p>window：检查重启是否成功之前的等待时间(即如果容器启动了, 隔多少秒之后去检测容器是否正常, 默认 0s)</p>
</li>
</ul>
</li>
<li><p>update_config：用于配置更新配置</p>
</li>
<li><ul>
<li><p>parallelism：一次性更新的容器数量</p>
</li>
<li><p>delay：更新一组容器之间的间隔时间</p>
</li>
<li><p>failure_action：定义更新失败的策略</p>
</li>
<li><ul>
<li>continue：继续更新</li>
<li>rollback：回滚更新</li>
<li>pause：暂停更新(默认)</li>
</ul>
</li>
<li><p>monitor：每次更新后的持续时间以监视更新是否失败(单位: ns|us|ms|s|m|h) (默认为0)</p>
</li>
<li><p>max_failure_ratio：回滚期间容忍的失败率(默认值为0)</p>
</li>
<li><p>order：v3.4 版本中新增的参数, 回滚期间的操作顺序</p>
</li>
<li><ul>
<li>stop-first：旧任务在启动新任务之前停止(默认)</li>
<li>start-first：首先启动新任务, 并且正在运行的任务暂时重叠</li>
</ul>
</li>
</ul>
</li>
<li><p>rollback_config：v3.7 版本中新增的参数, 用于定义在 update_config 更新失败的回滚策略</p>
</li>
<li><ul>
<li><p>parallelism：一次回滚的容器数, 如果设置为0, 则所有容器同时回滚</p>
</li>
<li><p>delay：每个组回滚之间的时间间隔(默认为0)</p>
</li>
<li><p>failure_action：定义回滚失败的策略</p>
</li>
<li><ul>
<li>continue：继续回滚</li>
<li>pause：暂停回滚</li>
</ul>
</li>
<li><p>monitor：每次回滚任务后的持续时间以监视失败(单位: ns|us|ms|s|m|h) (默认为0)</p>
</li>
<li><p>max_failure_ratio：回滚期间容忍的失败率(默认值0)</p>
</li>
<li><p>order：回滚期间的操作顺序</p>
</li>
<li><ul>
<li>stop-first：旧任务在启动新任务之前停止(默认)</li>
<li>start-first：首先启动新任务, 并且正在运行的任务暂时重叠</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>devices：指定设备映射列表(等同于 docker run –device)</p>
</li>
<li><p>depends_on：定义容器启动顺序</p>
</li>
</ul>
<h1 id="锚点操作符"><a href="#锚点操作符" class="headerlink" title="锚点操作符 &lt;&lt;"></a>锚点操作符 &lt;&lt;</h1><p>该描述符用于替代和引用 YAML 中已定义的块。即：将已定义好的模板(可以定义在文件顶部，也可以单独定义)插入到多个不同 service 中，减少荣誉和代码重复。</p>
<p>包含三个符号：</p>
<ul>
<li>&amp;：定义锚点，供以后使用</li>
<li>*：引用锚点</li>
<li>&lt;&lt;：用于将引用的块内容插入当前位置</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.4&#x27;</span> <span class="comment"># 定义一个公共配置块，在其他地方可以引用 </span></span><br><span class="line"></span><br><span class="line">common-config: &amp;common </span><br><span class="line">	environment: </span><br><span class="line">		APP_ENV: production </span><br><span class="line">		LOG_LEVEL: info </span><br><span class="line">	volumes: - /data/appdata:/app/data </span><br><span class="line">	</span><br><span class="line">    services: </span><br><span class="line">    	app-service: &lt;&lt;: *common <span class="comment"># 引用并插入 common-config 的内容</span></span><br><span class="line">        image: myapp:latest </span><br><span class="line">        ports: </span><br><span class="line">        	- <span class="string">&quot;8080:80&quot;</span> </span><br><span class="line">        	</span><br><span class="line">        another-service: &lt;&lt;: *common <span class="comment"># 再次引用并插入 common-config 的内容 </span></span><br><span class="line">        image: anotherapp:latest </span><br><span class="line">        ports: </span><br><span class="line">        	- <span class="string">&quot;9090:90&quot;</span></span><br></pre></td></tr></table></figure>





<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 描述 Compose 文件的版本信息</span></span><br><span class="line">version: <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="comment"># 定义服务，可以多个</span></span><br><span class="line">services:</span><br><span class="line">  nginx: <span class="comment"># 服务名称</span></span><br><span class="line">    image: nginx <span class="comment"># 创建容器时所需的镜像</span></span><br><span class="line">    container_name: mynginx <span class="comment"># 容器名称，默认为&quot;工程名称_服务条目名称_序号&quot;</span></span><br><span class="line">    ports: <span class="comment"># 宿主机与容器的端口映射关系</span></span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span> <span class="comment"># 左边宿主机端口:右边容器端口</span></span><br><span class="line">    restart: always <span class="comment"># 自动重启  </span></span><br><span class="line">    environment: <span class="comment"># 创建容器时所需的环境变量</span></span><br><span class="line">      NINX_PASSWORD: <span class="number">1234</span>   </span><br><span class="line">    networks: <span class="comment"># 配置容器连接的网络，引用顶级 networks 下的条目</span></span><br><span class="line">      - nginx-net</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义网络，可以多个。如果不声明，默认会创建一个网络名称为&quot;工程名称_default&quot;的 bridge 网络</span></span><br><span class="line">networks:</span><br><span class="line">  nginx-net: <span class="comment"># 一个具体网络的条目名称</span></span><br><span class="line">    name: nginx-net <span class="comment"># 网络名称，默认为&quot;工程名称_网络条目名称&quot;</span></span><br><span class="line">    driver: bridge <span class="comment"># 网络模式，默认为 bridge</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/22/Docker/Docker%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Damon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daemo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Daemo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/22/Docker/Docker%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Docker使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-22 15:48:37 / 修改时间：17:11:08" itemprop="dateCreated datePublished" datetime="2024-09-22T15:48:37+08:00">2024-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="运行参数"><a href="#运行参数" class="headerlink" title="运行参数"></a>运行参数</h1><table>
<thead>
<tr>
<th>option</th>
<th>默认参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>–add-host</td>
<td></td>
<td>将自定义主机添加到IP映射（host：ip）</td>
</tr>
<tr>
<td>–attach , -a</td>
<td></td>
<td>附加到STDIN，STDOUT或STDERR</td>
</tr>
<tr>
<td>–blkio-weight</td>
<td></td>
<td>IO（相对权重），介于10到1000之间，或者为0禁用（默认为0）</td>
</tr>
<tr>
<td>–blkio-weight-device</td>
<td></td>
<td>块IO重量（相对设备重量）</td>
</tr>
<tr>
<td>–cap-add</td>
<td></td>
<td>添加Linux功能</td>
</tr>
<tr>
<td>–cap-drop</td>
<td></td>
<td>放弃Linux功能</td>
</tr>
<tr>
<td>–cgroup-parent</td>
<td></td>
<td>容器的可选父cgroup</td>
</tr>
<tr>
<td>–cidfile</td>
<td></td>
<td>将容器ID写入文件</td>
</tr>
<tr>
<td>–cpu-count</td>
<td></td>
<td>CPU数量（仅Windows）</td>
</tr>
<tr>
<td>–cpu-percent</td>
<td></td>
<td>CPU百分比（仅Windows）</td>
</tr>
<tr>
<td>–cpu-period</td>
<td></td>
<td>限制CPU CFS（完全公平的调度程序）期限</td>
</tr>
<tr>
<td>–cpu-quota</td>
<td></td>
<td>限制CPU CFS（完全公平的调度程序）配额</td>
</tr>
<tr>
<td>–cpu-rt-period</td>
<td></td>
<td>限制CPU实时时间（以微秒为单位）</td>
</tr>
<tr>
<td>–cpu-rt-runtime</td>
<td></td>
<td>限制CPU实时运行时间（以微秒为单位）</td>
</tr>
<tr>
<td>-c, –cpu-shares</td>
<td></td>
<td>CPU份额（相对重量）</td>
</tr>
<tr>
<td>–cpus</td>
<td></td>
<td>CPU数量</td>
</tr>
<tr>
<td>–cpuset-cpus</td>
<td></td>
<td>允许执行的CPU（0-3，0,1）</td>
</tr>
<tr>
<td>–cpuset-mems</td>
<td></td>
<td>允许执行的MEM（0-3，0,1）</td>
</tr>
<tr>
<td>-d, –detach</td>
<td></td>
<td>在后台运行容器并打印容器ID</td>
</tr>
<tr>
<td>–detach-keys</td>
<td></td>
<td>覆盖分离容器的键序列</td>
</tr>
<tr>
<td>–device</td>
<td></td>
<td>将主机设备添加到容器</td>
</tr>
<tr>
<td>–device-cgroup-rule</td>
<td></td>
<td>在容器的 cgroup 中设置设备访问规则</td>
</tr>
<tr>
<td>–device-read-bps</td>
<td></td>
<td>限制从设备读取的速率（每秒字节数）</td>
</tr>
<tr>
<td>–device-read-iops</td>
<td></td>
<td>限制从设备读取的速率（每秒IO）</td>
</tr>
<tr>
<td>–device-write-bps</td>
<td></td>
<td>限制对设备的写入速率（每秒字节数）</td>
</tr>
<tr>
<td>–device-write-iops</td>
<td></td>
<td>限制对设备的写入速率（每秒IO）</td>
</tr>
<tr>
<td>–disable-content-trust</td>
<td>true</td>
<td>跳过图像验证</td>
</tr>
<tr>
<td>–dns</td>
<td></td>
<td>设置自定义DNS服务器(例如: 8.8.8.8)</td>
</tr>
<tr>
<td>–dns-opt</td>
<td></td>
<td>设定DNS选项</td>
</tr>
<tr>
<td>–dns-option</td>
<td></td>
<td>设定DNS选项</td>
</tr>
<tr>
<td>–dns-search</td>
<td></td>
<td>设置自定义DNS搜索域</td>
</tr>
<tr>
<td>–domainname</td>
<td></td>
<td>容器NIS域名</td>
</tr>
<tr>
<td>–entrypoint</td>
<td></td>
<td>覆盖图像的默认ENTRYPOINT</td>
</tr>
<tr>
<td>-e, –env</td>
<td></td>
<td>设置环境变量</td>
</tr>
<tr>
<td>–env-file</td>
<td></td>
<td>读入环境变量文件</td>
</tr>
<tr>
<td>–expose</td>
<td></td>
<td>公开一个或多个端口(8080,8081)</td>
</tr>
<tr>
<td>–gpus</td>
<td></td>
<td>API 1.40+GPU设备添加到容器中（“全部”传递所有GPU）</td>
</tr>
<tr>
<td>–group-add</td>
<td></td>
<td>添加其他群组即可加入</td>
</tr>
<tr>
<td>–health-cmd</td>
<td></td>
<td>运行命令以检查运行状况</td>
</tr>
<tr>
<td>–health-interval</td>
<td></td>
<td>运行检查之间的时间（ms</td>
</tr>
<tr>
<td>–health-retries</td>
<td></td>
<td>需要连续报告不健康状况</td>
</tr>
<tr>
<td>–health-start-period</td>
<td></td>
<td>API 1.29+ 容器在开始运行状况重试倒计时（ms</td>
</tr>
<tr>
<td>–health-timeout</td>
<td></td>
<td>允许执行一次检查的最长时间（ms</td>
</tr>
<tr>
<td>–help</td>
<td></td>
<td>打印用量</td>
</tr>
<tr>
<td>-h, –hostname</td>
<td></td>
<td>容器主机名(例如:例如:localhost)</td>
</tr>
<tr>
<td>–init</td>
<td></td>
<td>API 1.25+ 在容器内运行一个初始化程序，以转发信号并获取进程</td>
</tr>
<tr>
<td>-i, –interactive</td>
<td></td>
<td>即使未连接STDIN也保持打开状态</td>
</tr>
<tr>
<td>–io-maxbandwidth</td>
<td></td>
<td>系统驱动器的最大IO带宽限制（仅Windows）</td>
</tr>
<tr>
<td>–io-maxiops</td>
<td></td>
<td>系统驱动器的最大IOps限制（仅Windows）</td>
</tr>
<tr>
<td>–ip</td>
<td></td>
<td>IPv4地址（例如172.30.100.104）</td>
</tr>
<tr>
<td>–ip6</td>
<td></td>
<td>IPv6地址（例如2001：db8 :: 33）</td>
</tr>
<tr>
<td>–ipc</td>
<td></td>
<td>使用的IPC模式</td>
</tr>
<tr>
<td>–isolation</td>
<td></td>
<td>集装箱隔离技术</td>
</tr>
<tr>
<td>–kernel-memory</td>
<td></td>
<td>内核内存限制</td>
</tr>
<tr>
<td>-l, –label</td>
<td></td>
<td>在容器上设置元数据</td>
</tr>
<tr>
<td>–label-file</td>
<td></td>
<td>读入行分隔的标签文件</td>
</tr>
<tr>
<td>–link</td>
<td></td>
<td>将链接添加到另一个容器</td>
</tr>
<tr>
<td>–link-local-ip</td>
<td></td>
<td>容器IPv4 &#x2F; IPv6链接本地地址</td>
</tr>
<tr>
<td>–log-driver</td>
<td></td>
<td>容器的日志记录驱动程序</td>
</tr>
<tr>
<td>–log-opt</td>
<td></td>
<td>日志驱动程序选项</td>
</tr>
<tr>
<td>–mac-address</td>
<td></td>
<td>容器MAC地址（例如92：d0：c6：0a：29：33）</td>
</tr>
<tr>
<td>-m,–memory</td>
<td></td>
<td>内存限制</td>
</tr>
<tr>
<td>–memory-reservation</td>
<td></td>
<td>内存软限制</td>
</tr>
<tr>
<td>–memory-swap</td>
<td></td>
<td>交换限制等于内存加交换：“-1”以启用无限交换</td>
</tr>
<tr>
<td>–memory-swappiness</td>
<td>-1</td>
<td>调整容器内存交换（0到100）</td>
</tr>
<tr>
<td>–mount</td>
<td></td>
<td>将文件系统挂载附加到容器</td>
</tr>
<tr>
<td>–name</td>
<td></td>
<td>为容器分配一个名称</td>
</tr>
<tr>
<td>–net</td>
<td></td>
<td>网络模式(host, bridge)</td>
</tr>
<tr>
<td>–net-alias</td>
<td></td>
<td>为容器添加网络范围的别名</td>
</tr>
<tr>
<td>–network</td>
<td></td>
<td>网络名(可以多个容器公用一个网络名,这样多容器会在同一个网络环境下)</td>
</tr>
<tr>
<td>–network-alias</td>
<td></td>
<td>网络别名(未知)</td>
</tr>
<tr>
<td>–no-healthcheck</td>
<td></td>
<td>禁用任何容器指定的健康检查</td>
</tr>
<tr>
<td>–oom-kill-disable</td>
<td></td>
<td>禁用OOM杀手</td>
</tr>
<tr>
<td>–oom-score-adj</td>
<td></td>
<td>调台主持人的OOM首选项（-1000至1000）</td>
</tr>
<tr>
<td>–pid</td>
<td></td>
<td>使用的PID名称空间</td>
</tr>
<tr>
<td>–pids-limit</td>
<td></td>
<td>调整容器pids限制（将-1设置为无限制）</td>
</tr>
<tr>
<td>–platform</td>
<td></td>
<td>实验（守护程序）API 1.32+ 如果服务器具有多平台功能，请设置平台</td>
</tr>
<tr>
<td>–privileged</td>
<td></td>
<td>赋予此容器扩展的特权</td>
</tr>
<tr>
<td>-p, –publish</td>
<td></td>
<td>将容器的端口发布到主机</td>
</tr>
<tr>
<td>-P, –publish-all</td>
<td></td>
<td>将所有公开的端口发布到随机端口</td>
</tr>
<tr>
<td>–read-only</td>
<td></td>
<td>将容器的根文件系统挂载为只读</td>
</tr>
<tr>
<td>–restart</td>
<td>no</td>
<td>容器退出时重新启动策略以应用(no</td>
</tr>
<tr>
<td>–rm</td>
<td></td>
<td>退出时自动删除容器</td>
</tr>
<tr>
<td>–runtime</td>
<td></td>
<td>用于此容器的运行时</td>
</tr>
<tr>
<td>–security-opt</td>
<td></td>
<td>安全选项</td>
</tr>
<tr>
<td>–shm-size</td>
<td></td>
<td>&#x2F; dev &#x2F; shm的大小</td>
</tr>
<tr>
<td>–sig-proxy</td>
<td>true</td>
<td>代理接收到该过程的信号</td>
</tr>
<tr>
<td>–stop-signal</td>
<td>SIGTERM</td>
<td>停止容器的信号</td>
</tr>
<tr>
<td>–stop-timeout</td>
<td></td>
<td>API 1.25+ 超时（以秒为单位）以停止容器</td>
</tr>
<tr>
<td>–storage-opt</td>
<td></td>
<td>容器的存储驱动程序选项</td>
</tr>
<tr>
<td>–sysctl</td>
<td></td>
<td>Sysctl选项</td>
</tr>
<tr>
<td>–tmpfs</td>
<td></td>
<td>挂载tmpfs目录</td>
</tr>
<tr>
<td>-t, –tty</td>
<td></td>
<td>分配伪TTY</td>
</tr>
<tr>
<td>–ulimit</td>
<td></td>
<td>Ulimit选项</td>
</tr>
<tr>
<td>-u, –user</td>
<td></td>
<td>用户名或UID（格式：&lt;名称</td>
</tr>
<tr>
<td>–userns</td>
<td></td>
<td>要使用的用户名称空间</td>
</tr>
<tr>
<td>–uts</td>
<td></td>
<td>使用的UTS名称空间</td>
</tr>
<tr>
<td>-v,–volume</td>
<td></td>
<td>绑定挂载卷</td>
</tr>
<tr>
<td>–volume-driver</td>
<td></td>
<td>容器的可选音量驱动器</td>
</tr>
<tr>
<td>–volumes-from</td>
<td></td>
<td>从指定的容器挂载卷</td>
</tr>
<tr>
<td>-w,–workdir</td>
<td></td>
<td>容器内的工作目录</td>
</tr>
</tbody></table>
<h2 id="privileged"><a href="#privileged" class="headerlink" title="--privileged"></a><code>--privileged</code></h2><p>该选项允许容器以 root 权限运行，获得几乎与主机相同的权限。意味着容器可以访问和控制主机的所有硬件设备、操作系统内核和其他系统资源。</p>
<blockquote>
<hr>
<p>使用 <code>--privileged=true</code> 后，容器内的 root 才真正拥有 root 权限，否则容器内 root 只是一个普通用户</p>
<hr>
</blockquote>
<p>使能该选项存在巨大安全风险。允许容器以超级用户权限运行，意味着容器内的任何恶意代码都可以获得主机上的完全访问权限。攻击者可以利用这种权限执行任意操作，包括但不限于数据窃取、系统破坏和网络]攻击。</p>
<h2 id="device-cgroup-rule"><a href="#device-cgroup-rule" class="headerlink" title="--device-cgroup-rule"></a><code>--device-cgroup-rule</code></h2><p><code>--device-cgroup-rule</code> 可指定一系列 cgroup 规则，以允许或禁止容器对特定设备的访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--device-cgroup-rule=&quot;type major:minor mode&quot;</span><br><span class="line">  Add a rule to the cgroup allowed devices list. The rule is expected to be in the format specified in the Linux kernel documentation (Documentation/cgroup-v1/devices.txt):</span><br><span class="line">    - type: a (all), c (char), or b (block);</span><br><span class="line">    - major and minor: either a number, or * for all;</span><br><span class="line">    - mode: a composition of r (read), w (write), and m (mknod(2)).</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Docker CE17.04 引入</p>
</blockquote>
<blockquote>
<p>major</p>
<ul>
<li>81: USB</li>
<li>189: UVC</li>
</ul>
</blockquote>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker version</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">搜索可用镜像</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker search &lt;image name&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除镜像</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker rmi &lt;image name&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除容器</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">rm</span> &lt;container&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">$ docker <span class="built_in">rm</span> $(docker ps -aq) <span class="comment"># 删除所有容器</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止容器</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker stop &lt;container name&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker stop $(docker ps -aq) <span class="comment"># 停止所有容器</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">构建镜像</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker build -t &lt;镜像名 name:tag&gt; [-f &lt;dockerfile 路径&gt;]</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker build -t &#123;镜像名&#125; &#123;路径&#125;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker build -t &#123;镜像名&#125; - &lt; Dockerfile路径</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从容器构建镜像</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker commit [-a/c/m/p] &lt;container&gt; &lt;image&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝文件</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">cp</span> host_path containerID:container_path</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">cp</span> containerID:container_path host_path</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看容器端口映射</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker port CONTAINER [PRIVATE_PORT[/PROTO]]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">history</span> &lt;image&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 tag. 第一个参数为原始镜像标签</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker tag IMAGE[:TAG] IMAGE[:TAG]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看某个容器详细信息</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker inspect</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker diff</span></span><br></pre></td></tr></table></figure>



<h1 id="访问主机设备"><a href="#访问主机设备" class="headerlink" title="访问主机设备"></a>访问主机设备</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 --privileged（允许访问主机所有设备）</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --privileged --<span class="built_in">tty</span> --interactive debian /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 -volume</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --<span class="built_in">tty</span> --interactive --volume=/dev/bus/usb:/dev/bus/usb --volume=/dev/sdb:/dev/sdb debian /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 -device</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --<span class="built_in">tty</span> --interactive --device=/dev/bus/usb --device=/dev/sdb debian /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 cgroup rule</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --device-cgroup-rule=<span class="string">&#x27;c 81:* rwm&#x27;</span> --<span class="built_in">tty</span> --interactive debian /bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用该方式，为了确保 plug 事件触发重分配，还需要添加 udev 规则，参考 realsense docker</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="热插拔"><a href="#热插拔" class="headerlink" title="热插拔"></a>热插拔</h2><blockquote>
<p><code>-v/volume</code> 及 <code>-device</code> 无法解决热插拔问题。在容器已经运行时插入或重新插入设备，在这种场景中，设备可能获得不同的总线 ID，从而使原始共享失效。（<strong>需要注意的是，当共享整个 &#x2F;dev 目录时，这不是问题</strong>）</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 映射此类设备整个总线，例如 针对 USB 设备，可映射整个 USB 总线</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --device=/dev/bus/usb -it --name ros_container &lt;image&gt; /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 使用 --device-cgroup-rule 映射此类别所有设备</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --device-cgroup-rule=<span class="string">&#x27;c 81:* rwm&#x27;</span> --<span class="built_in">tty</span> --interactive debian /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 使用 --privileged 模式</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --privileged -it --name ros_container &lt;image&gt; /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 重新映射。例如，USB 设备</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -ti &lt;container&gt; bash -c <span class="string">&quot;mount --bind /dev/bus/usb /dev/bus/usb&quot;</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. 动态添加到容器</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker update --device-add /dev/bus/usb/001/026 &lt;container_name&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. 使用 udev 固定设备路径，容器启动时映射这些路径</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>容器内 <code>systemd-udevd</code> 不启动。因为容器中 &#x2F;sys 默认时 ro 只读模式，避免容器环境与主机对于 &#x2F;sys 同时写入导致的资源冲突问题。</p>
<p><code>systemd-udevd.service</code> 服务文件会检查该权限</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Damon</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">523k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">15:50</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
